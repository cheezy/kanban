# Stride Integration - Gemini Code Assist Instructions

## HOOK EXECUTION (MANDATORY)

Stride enforces workflow discipline through four client-side hooks that execute on the developer's machine:

- **before_doing** (60s, blocking) - Execute before starting work (pull code, setup)
- **after_doing** (120s, blocking) - Execute after work, BEFORE calling complete endpoint (tests, lint)
- **before_review** (60s, non-blocking) - Execute when entering review (create PR, docs)
- **after_review** (60s, non-blocking) - Execute after approval (merge, deploy)

**CRITICAL:** Always execute the `after_doing` hook BEFORE calling the task completion endpoint. Hook validation failures must prevent task completion.

## TOP 5 CRITICAL MISTAKES

### 1. Specifying Identifiers When Creating Tasks

**DON'T DO THIS:**
```json
{
  "identifier": "W47",
  "title": "Add dark mode",
  "type": "work"
}
```

**DO THIS:**
```json
{
  "title": "Add dark mode",
  "type": "work"
}
```

**WHY:** Identifiers are auto-generated by the system (G1, W47, D12). Specifying them causes API rejection.

### 2. Using String Arrays for verification_steps

**DON'T DO THIS:**
```json
{
  "verification_steps": [
    "Run mix test",
    "Check coverage"
  ]
}
```

**DO THIS:**
```json
{
  "verification_steps": [
    {
      "step_type": "command",
      "step_text": "mix test path/to/test.exs",
      "expected_result": "All tests pass",
      "position": 0
    }
  ]
}
```

**WHY:** `verification_steps` must be array of objects with `step_type`, `step_text`, `expected_result`, and `position`.

### 3. Using Non-Array Values for testing_strategy Fields

**DON'T DO THIS:**
```json
{
  "testing_strategy": {
    "unit_tests": "Test the auth flow",
    "integration_tests": "Test end-to-end",
    "manual_tests": "Click the button"
  }
}
```

**DO THIS:**
```json
{
  "testing_strategy": {
    "unit_tests": ["Test JWT generation", "Test token validation"],
    "integration_tests": ["Full auth flow with database"],
    "manual_tests": ["Verify login form works"],
    "edge_cases": ["Expired tokens", "Invalid credentials"],
    "coverage_target": "100% for auth module"
  }
}
```

**WHY:** `unit_tests`, `integration_tests`, and `manual_tests` must be arrays of strings.

### 4. Using Wrong Type Values

**DON'T DO THIS:**
```json
{
  "type": "task"
}
```

**DO THIS:**
```json
{
  "type": "work"
}
```

**WHY:** `type` must be exactly `"work"`, `"defect"`, or `"goal"` as strings.

### 5. Calling Complete Endpoint Before Executing after_doing Hook

**DON'T DO THIS:**
1. Finish work
2. Call `PATCH /api/tasks/:id/complete`
3. Execute `after_doing` hook

**DO THIS:**
1. Finish work
2. Execute `after_doing` hook (tests, lint, build)
3. Only if hook succeeds, call `PATCH /api/tasks/:id/complete`

**WHY:** Hook validation failures must prevent task completion. Calling complete first bypasses quality gates.

## ESSENTIAL TASK FIELDS

**Required:**
- `type` - Exactly `"work"`, `"defect"`, or `"goal"`
- `title` - Clear, specific description

**Critical:**
- `key_files` - Prevents merge conflicts
- `dependencies` - Controls execution order
- `verification_steps` - Array of objects
- `testing_strategy` - Must have arrays for unit/integration/manual tests

**Strongly Recommended:**
- `description` - WHY this matters and WHAT needs to be done
- `complexity` - `"small"`, `"medium"`, or `"large"`
- `priority` - `"low"`, `"medium"`, `"high"`, or `"critical"`
- `needs_review` - Boolean controlling review requirement
- `pitfalls` - Array of what NOT to do
- `patterns_to_follow` - Code patterns to replicate
- `acceptance_criteria` - Definition of done
- `why` - Problem/value explanation
- `what` - Specific change description
- `where_context` - Location in code/UI

## CODE PATTERN: Claiming a Task

```bash
# 1. Find available task
curl -H "Authorization: Bearer $TOKEN" \
  https://www.stridelikeaboss.com/api/tasks/next

# 2. Claim task (returns before_doing hook)
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"task_id": 123, "agent_name": "Gemini Code Assist"}' \
  https://www.stridelikeaboss.com/api/tasks/claim
```

**Response includes:**
```json
{
  "task": {...},
  "hook": {
    "name": "before_doing",
    "command": "git pull origin main && mix deps.get",
    "timeout": 60000,
    "blocking": true,
    "env": {
      "TASK_ID": "123",
      "TASK_IDENTIFIER": "W47",
      "TASK_TITLE": "Add dark mode"
    }
  }
}
```

**Next steps:**
1. Set environment variables from `hook.env`
2. Execute `hook.command` with timeout
3. Check exit code (blocking hook must succeed)
4. Begin work

## CODE PATTERN: Completing a Task

```bash
# 1. Finish implementation

# 2. Execute after_doing hook FIRST
# - Parse hook metadata from .stride.md
# - Set environment variables
# - Execute hook command with 120s timeout
# - Check exit code - if non-zero, stop here and fix issues

# 3. Only if hook succeeds, call complete endpoint
curl -X PATCH \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_name": "Gemini Code Assist",
    "time_spent_minutes": 45,
    "completion_notes": "Implemented feature X. All tests passing."
  }' \
  https://www.stridelikeaboss.com/api/tasks/123/complete
```

**Response includes:** `before_review`, `after_doing`, and `after_review` hooks

**4. Execute before_review hook** (non-blocking, continue even if it fails)

## CODE PATTERN: Creating a Simple Task

```json
{
  "type": "work",
  "title": "Add user authentication",
  "description": "Implement JWT-based authentication for API endpoints",
  "complexity": "medium",
  "priority": "high",
  "needs_review": true,
  "key_files": [
    {
      "file_path": "lib/auth.ex",
      "note": "Main authentication logic",
      "position": 0
    }
  ],
  "verification_steps": [
    {
      "step_type": "command",
      "step_text": "mix test test/auth_test.exs",
      "expected_result": "All authentication tests pass",
      "position": 0
    }
  ],
  "testing_strategy": {
    "unit_tests": ["JWT token generation", "Token validation"],
    "integration_tests": ["Full auth flow with database"],
    "edge_cases": ["Expired tokens", "Invalid signatures"]
  },
  "acceptance_criteria": "Users can authenticate with valid credentials\nInvalid credentials return 401\nTokens expire after configured duration",
  "pitfalls": ["Don't store passwords in plain text", "Don't skip token expiration checks"]
}
```

## CODE PATTERN: Creating a Goal with Nested Tasks

```json
{
  "type": "goal",
  "title": "Implement complete authentication system",
  "description": "Full auth system with login, logout, and token refresh",
  "complexity": "large",
  "priority": "critical",
  "tasks": [
    {
      "type": "work",
      "title": "Create user authentication schema",
      "complexity": "small",
      "key_files": [{"file_path": "priv/repo/migrations/xxx_create_users.exs", "note": "User table migration", "position": 0}],
      "verification_steps": [{"step_type": "command", "step_text": "mix ecto.migrate", "expected_result": "Migration successful", "position": 0}],
      "testing_strategy": {"unit_tests": ["Schema validation"]}
    },
    {
      "type": "work",
      "title": "Implement JWT token generation",
      "complexity": "medium",
      "dependencies": [0],
      "key_files": [{"file_path": "lib/auth/jwt.ex", "note": "JWT logic", "position": 0}],
      "verification_steps": [{"step_type": "command", "step_text": "mix test test/auth/jwt_test.exs", "expected_result": "All tests pass", "position": 0}],
      "testing_strategy": {"unit_tests": ["Token generation", "Token validation"]}
    }
  ]
}
```

## CODE PATTERN: Batch Creating Multiple Goals

```json
{
  "goals": [
    {
      "title": "Authentication System",
      "type": "goal",
      "complexity": "large",
      "tasks": [
        {"title": "User schema", "type": "work", "complexity": "small"},
        {"title": "JWT generation", "type": "work", "complexity": "medium", "dependencies": [0]}
      ]
    },
    {
      "title": "Authorization System",
      "type": "goal",
      "complexity": "large",
      "tasks": [
        {"title": "Role-based access", "type": "work", "complexity": "medium"},
        {"title": "Permission checks", "type": "work", "complexity": "medium", "dependencies": [0]}
      ]
    }
  ]
}
```

**POST to:** `https://www.stridelikeaboss.com/api/tasks/batch`

**CRITICAL:** The root key must be `"goals"` (not `"tasks"`). Dependencies work within goals using array indices `[0, 1, 2]`. Cross-goal dependencies don't work in batch requests.

## QUICK REFERENCE

**API Base URL:** `https://www.stridelikeaboss.com`

**Authentication:** Bearer token in `Authorization` header

**Required Files:**
- `.stride.md` - Hook definitions (version-controlled)
- `.stride_auth.md` - API token (gitignored)

**Workflow:**
1. Claim task → Execute `before_doing` hook → Implement → Execute `after_doing` hook → Complete task
2. If `needs_review=false`: Claim next task automatically
3. If `needs_review=true`: Stop and wait for human review

**Documentation:**
- Onboarding: `https://www.stridelikeaboss.com/api/agent/onboarding`
- Task Writing Guide: `https://raw.githubusercontent.com/cheezy/kanban/refs/heads/main/docs/TASK-WRITING-GUIDE.md`
- API Reference: `https://raw.githubusercontent.com/cheezy/kanban/refs/heads/main/docs/api/README.md`
- Hook Execution: `https://raw.githubusercontent.com/cheezy/kanban/refs/heads/main/docs/AGENT-HOOK-EXECUTION-GUIDE.md`

## NEVER DO

- ❌ Specify identifiers (G1, W47, D12) when creating tasks
- ❌ Use string arrays for `verification_steps` (must be objects)
- ❌ Use strings for `testing_strategy` fields (must be arrays)
- ❌ Use `type: "task"` (must be `"work"`, `"defect"`, or `"goal"`)
- ❌ Call complete endpoint before executing `after_doing` hook
- ❌ Skip hook execution (they enforce quality gates)
- ❌ Commit `.stride_auth.md` to version control (contains secrets)
- ❌ Create minimal tasks (include context, key_files, verification_steps, testing_strategy)

## ALWAYS DO

- ✅ Execute `after_doing` hook BEFORE calling complete endpoint
- ✅ Include `key_files` to prevent merge conflicts
- ✅ Provide comprehensive `testing_strategy` with arrays
- ✅ Use object format for `verification_steps`
- ✅ Add `.stride_auth.md` to `.gitignore`
- ✅ Set all environment variables from hook metadata before executing
- ✅ Check hook exit codes (blocking hooks must succeed)
- ✅ Create detailed tasks with acceptance criteria and pitfalls
- ✅ Continue claiming tasks until `needs_review=true` or no tasks available
