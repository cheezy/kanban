# Stride Integration - GitHub Copilot Instructions

## Hook Execution (Mandatory)

Stride enforces workflow discipline through four client-side hooks that execute on the developer's machine:

- **before_doing** (60s, blocking) - Execute before starting work (pull code, setup)
- **after_doing** (120s, blocking) - Execute after work, BEFORE calling complete endpoint (tests, lint)
- **before_review** (60s, non-blocking) - Execute when entering review (create PR, docs)
- **after_review** (60s, non-blocking) - Execute after approval (merge, deploy)

**Critical:** Always execute the after_doing hook BEFORE calling the task completion endpoint. Hook validation failures must prevent task completion.

## Top 5 Critical Mistakes

### 1. Specifying Identifiers When Creating Tasks

**DON'T DO THIS:**
```json
{
  "identifier": "W47",
  "title": "Add dark mode",
  "type": "work"
}
```

**DO THIS:**
```json
{
  "title": "Add dark mode",
  "type": "work"
}
```

**Why:** Identifiers are auto-generated by the system (G1, W47, D12). Specifying them causes API rejection.

### 2. Using String Arrays for verification_steps

**DON'T DO THIS:**
```json
{
  "verification_steps": [
    "Run mix test",
    "Check coverage"
  ]
}
```

**DO THIS:**
```json
{
  "verification_steps": [
    {
      "step_type": "command",
      "step_text": "mix test path/to/test.exs",
      "expected_result": "All tests pass",
      "position": 0
    }
  ]
}
```

**Why:** verification_steps must be array of objects with step_type, step_text, expected_result, and position.

### 3. Using Non-Array Values for testing_strategy Fields

**DON'T DO THIS:**
```json
{
  "testing_strategy": {
    "unit_tests": "Test the auth flow",
    "integration_tests": "Test end-to-end",
    "manual_tests": "Click the button"
  }
}
```

**DO THIS:**
```json
{
  "testing_strategy": {
    "unit_tests": ["Test JWT generation", "Test token validation"],
    "integration_tests": ["Full auth flow with database"],
    "manual_tests": ["Verify login form works"],
    "edge_cases": ["Expired tokens", "Invalid credentials"],
    "coverage_target": "100% for auth module"
  }
}
```

**Why:** unit_tests, integration_tests, and manual_tests must be arrays of strings.

### 4. Using Wrong Type Values

**DON'T DO THIS:**
```json
{
  "type": "task"
}
```

**DO THIS:**
```json
{
  "type": "work"
}
```

**Why:** type must be exactly "work", "defect", or "goal" as strings.

### 5. Calling Complete Endpoint Before Executing after_doing Hook

**DON'T DO THIS:**
1. Finish work
2. Call PATCH /api/tasks/:id/complete
3. Execute after_doing hook

**DO THIS:**
1. Finish work
2. Execute after_doing hook (tests, lint, build)
3. Only if hook succeeds, call PATCH /api/tasks/:id/complete

**Why:** Hook validation failures must prevent task completion. Calling complete first bypasses quality gates.

## Essential Task Fields

### Required
- `type` - Exactly "work", "defect", or "goal"
- `title` - Clear, specific description

### Critical
- `key_files` - Prevents merge conflicts
- `dependencies` - Controls execution order
- `verification_steps` - Array of objects
- `testing_strategy` - Must have arrays for unit/integration/manual tests

### Strongly Recommended
- `description` - WHY this matters and WHAT needs to be done
- `complexity` - "small", "medium", or "large"
- `priority` - "low", "medium", "high", or "critical"
- `needs_review` - Boolean controlling review requirement
- `pitfalls` - Array of what NOT to do
- `patterns_to_follow` - Code patterns to replicate
- `acceptance_criteria` - Definition of done

## Code Pattern: Claiming a Task

```bash
# 1. Find available task
curl -H "Authorization: Bearer $TOKEN" \
  https://www.stridelikeaboss.com/api/tasks/next

# 2. Claim task (returns before_doing hook)
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"task_id": 123, "agent_name": "Your Name"}' \
  https://www.stridelikeaboss.com/api/tasks/claim

# 3. Execute before_doing hook
# Parse hook metadata from response
# Set environment variables
# Execute hook command with timeout
# Check exit code (blocking hook must succeed)

# 4. Begin work
```

## Code Pattern: Completing a Task

```bash
# 1. Finish implementation

# 2. Execute after_doing hook FIRST
# Parse hook metadata
# Set environment variables
# Execute hook command with 120s timeout
# Check exit code - if non-zero, stop here and fix issues

# 3. Only if hook succeeds, call complete endpoint
curl -X PATCH \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_name": "Your Name",
    "time_spent_minutes": 45,
    "completion_notes": "Implemented feature X. All tests passing."
  }' \
  https://www.stridelikeaboss.com/api/tasks/123/complete

# 4. Execute before_review hook (non-blocking)
# Continue even if it fails
```

## Code Pattern: Creating a Task

```json
POST /api/tasks
{
  "type": "work",
  "title": "Add JWT authentication to API",
  "description": "Implement JWT token-based authentication to secure API endpoints. Currently using basic auth which is insecure.",
  "complexity": "medium",
  "priority": "high",
  "needs_review": true,
  "key_files": [
    {
      "file_path": "lib/myapp_web/plugs/auth.ex",
      "note": "New authentication plug",
      "position": 0
    }
  ],
  "verification_steps": [
    {
      "step_type": "command",
      "step_text": "mix test test/myapp_web/plugs/auth_test.exs",
      "expected_result": "All auth tests pass",
      "position": 0
    }
  ],
  "testing_strategy": {
    "unit_tests": ["Test JWT generation", "Test token validation", "Test expired tokens"],
    "integration_tests": ["Test protected endpoint access"],
    "manual_tests": ["Verify API returns 401 without token"],
    "edge_cases": ["Malformed tokens", "Missing signature"],
    "coverage_target": "100% for auth module"
  },
  "pitfalls": ["Don't store tokens in localStorage without encryption", "Don't skip token expiration validation"],
  "patterns_to_follow": "Follow Guardian library patterns from existing sessions controller",
  "acceptance_criteria": "API endpoints require valid JWT token\nToken refresh works correctly\nInvalid tokens return 401"
}
```

## Code Pattern: Creating a Goal with Tasks

```json
POST /api/tasks
{
  "type": "goal",
  "title": "User Authentication System",
  "description": "Complete authentication system with login, registration, and password reset",
  "complexity": "large",
  "priority": "high",
  "tasks": [
    {
      "type": "work",
      "title": "Add JWT library and configuration",
      "complexity": "small",
      "verification_steps": [
        {
          "step_type": "command",
          "step_text": "mix deps.get && mix compile",
          "expected_result": "Guardian dependency compiles",
          "position": 0
        }
      ],
      "testing_strategy": {
        "unit_tests": ["Test config loads correctly"],
        "integration_tests": [],
        "manual_tests": []
      }
    },
    {
      "type": "work",
      "title": "Create authentication endpoints",
      "complexity": "medium",
      "dependencies": [0],
      "verification_steps": [
        {
          "step_type": "command",
          "step_text": "mix test test/myapp_web/controllers/auth_test.exs",
          "expected_result": "All auth endpoint tests pass",
          "position": 0
        }
      ],
      "testing_strategy": {
        "unit_tests": ["Test login success", "Test login failure"],
        "integration_tests": ["Full auth flow"],
        "manual_tests": ["Verify endpoints work in Postman"]
      }
    }
  ]
}
```

## Batch Creation Pattern

```json
POST /api/tasks/batch
{
  "goals": [
    {
      "type": "goal",
      "title": "Authentication System",
      "complexity": "large",
      "tasks": [
        {
          "type": "work",
          "title": "Add JWT library",
          "complexity": "small"
        },
        {
          "type": "work",
          "title": "Create auth endpoints",
          "complexity": "medium",
          "dependencies": [0]
        }
      ]
    },
    {
      "type": "goal",
      "title": "User Profile Management",
      "complexity": "large",
      "tasks": [
        {
          "type": "work",
          "title": "Profile schema migration",
          "complexity": "small"
        }
      ]
    }
  ]
}
```

**CRITICAL:** Root key must be `"goals"` (not `"tasks"`). Dependencies within goals use array indices [0, 1]. Cross-goal dependencies don't work in batch - create separately.

## Documentation Links

- Onboarding: https://www.stridelikeaboss.com/api/agent/onboarding
- Task Writing Guide: https://raw.githubusercontent.com/cheezy/kanban/refs/heads/main/docs/TASK-WRITING-GUIDE.md
- API Reference: https://raw.githubusercontent.com/cheezy/kanban/refs/heads/main/docs/api/README.md
- Hook Execution: https://raw.githubusercontent.com/cheezy/kanban/refs/heads/main/docs/AGENT-HOOK-EXECUTION-GUIDE.md

## Note

These instructions provide essential guidance for code completion. For comprehensive workflow enforcement, Claude Code users should install the four Stride Skills from the onboarding endpoint.
