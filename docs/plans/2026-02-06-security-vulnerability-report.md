# Security Vulnerability Report - Stride Codebase

*Audit performed: February 6, 2026*

## Critical

### 1. XSS in Markdown Rendering

- **Files:** `lib/kanban_web/live/resources_live/show.ex` (lines 60-125), `lib/kanban_web/live/resources_live/components.ex` (line 190)
- **Issue:** The `render_markdown()` function inserts user content into HTML tags without escaping. Combined with `Phoenix.HTML.raw()` in the components module, this allows script execution. Input like `` `<script>alert('XSS')</script>` `` would be rendered as executable HTML.
- **Fix:** Use an established markdown library like Earmark with safe HTML output, or escape captured groups with `Plug.HTML.html_escape()` before insertion.

### 2. SMTP SSL/TLS Verification Disabled

- **File:** `config/runtime.exs` (line 116)
- **Issue:** `sockopts: [{:verify, :verify_none}]` disables certificate verification for SMTP connections, enabling man-in-the-middle attacks on email transmission.
- **Fix:** Change to `:verify_peer` with proper CA certificates:

```elixir
sockopts: [
  {:verify, :verify_peer},
  {:cacerts, :public_key.cacerts_get()}
]
```

---

## High

### 3. No Rate Limiting on Authentication Endpoints

- **Files:** `lib/kanban_web/controllers/user_session_controller.ex`, `lib/kanban_web/live/user_live/forgot_password.ex`
- **Issue:** Login, registration, and password reset endpoints have no rate limiting, enabling brute force attacks, credential stuffing, and DoS on the email system.
- **Fix:** Add rate limiting with a library like `hammer` or `ex_rated`.

### 4. Insecure Content Security Policy

- **File:** `lib/kanban_web/router.ex` (lines 16-19)
- **Issue:** CSP allows `'unsafe-inline'` for both scripts and styles, which largely negates CSP's XSS protection.
- **Current:** `"default-src 'self'; script-src 'self' 'unsafe-inline'; img-src 'self' data:; style-src 'self' 'unsafe-inline'"`
- **Fix:** Implement nonce-based CSP without `unsafe-inline`.

### 5. Missing force_ssl in Production Config

- **File:** `config/runtime.exs` (lines 95-100)
- **Issue:** The `force_ssl` configuration with HSTS is commented out. While `fly.toml` enforces HTTPS at the proxy level, HSTS headers are not being set by the application.
- **Fix:** Uncomment `force_ssl: [hsts: true]`.

---

## Medium

### 6. Session Cookie Not Encrypted

- **File:** `lib/kanban_web/endpoint.ex` (line 7)
- **Issue:** Sessions are signed but not encrypted. A comment notes encryption is available but not configured. Sensitive data in sessions could be read if a cookie is intercepted.
- **Fix:** Add `encryption_salt` to session options.

### 7. Missing secure: true on Cookies

- **File:** `lib/kanban_web/endpoint.ex` (lines 5-10)
- **Issue:** Session and remember-me cookies don't explicitly set `secure: true`, meaning cookies could be transmitted over HTTP.
- **Fix:** Add `secure: true` to cookie options for production.

### 8. Potential Timing Attack on API Token Lookup

- **File:** `lib/kanban/api_tokens.ex` (lines 72-87)
- **Issue:** Different code paths for "not found" vs "revoked" tokens could leak information via response timing differences.
- **Fix:** Normalize response timing across all paths.

### 9. Sobelow HTTPS Check Suppressed

- **File:** `.sobelow-conf`
- **Issue:** The `Config.HTTPS` check is in the ignore list, hiding SSL misconfigurations from security analysis.
- **Fix:** Remove from ignore list.

---

## Low

### 10. Email Disclosure in Board Invitations

- **File:** `lib/kanban_web/live/board_live/form.ex`
- **Issue:** Error message reveals whether an email is registered when searching for users to add to a board. Minor user enumeration risk.

### 11. SameSite Cookie Policy

- **File:** `lib/kanban_web/endpoint.ex` (line 10)
- **Issue:** Uses `Lax` instead of `Strict`. Acceptable for most cases but `Strict` provides stronger CSRF protection.

---

## Areas Confirmed Secure

| Area | Status | Notes |
|------|--------|-------|
| SQL Injection | Safe | All queries use parameterized Ecto |
| Password Hashing | Safe | Bcrypt with timing-safe comparison |
| API Token Storage | Safe | SHA256 hashed, not plaintext |
| CSRF Protection | Safe | Phoenix built-in protection enabled |
| Board Authorization | Safe | Membership checked on all routes |
| API Authorization | Safe | Token + board ownership validated |
| Command Injection | Safe | No shell execution with user input |
| Path Traversal | Safe | No file operations with user-supplied paths |
| Mass Assignment | Safe | Explicit cast whitelist in changesets |
| User Enumeration (login) | Safe | Generic "Invalid email or password" message |

---

## Recommended Priority

1. **Now:** Fix XSS in markdown rendering (#1) and SMTP SSL verification (#2)
2. **Soon:** Add rate limiting (#3) and fix CSP (#4)
3. **Next sprint:** Enable force_ssl (#5), cookie hardening (#6, #7), and session encryption
