# Security Vulnerability Report - Stride Codebase

*Audit performed: February 6, 2026*

## Critical

### 1. SMTP SSL/TLS Verification Disabled

- **File:** `config/runtime.exs` (line 116)
- **Issue:** `sockopts: [{:verify, :verify_none}]` disables certificate verification for SMTP connections, enabling man-in-the-middle attacks on email transmission.
- **Fix:** Change to `:verify_peer` with proper CA certificates:

```elixir
sockopts: [
  {:verify, :verify_peer},
  {:cacerts, :public_key.cacerts_get()}
]
```

---

## High

### 2. No Rate Limiting on Authentication Endpoints

- **Files:** `lib/kanban_web/controllers/user_session_controller.ex`, `lib/kanban_web/live/user_live/forgot_password.ex`
- **Issue:** Login, registration, and password reset endpoints have no rate limiting, enabling brute force attacks, credential stuffing, and DoS on the email system.
- **Fix:** Add rate limiting with a library like `hammer` or `ex_rated`.

### 3. Insecure Content Security Policy

- **File:** `lib/kanban_web/router.ex` (lines 16-19)
- **Issue:** CSP allows `'unsafe-inline'` for both scripts and styles, which largely negates CSP's XSS protection.
- **Current:** `"default-src 'self'; script-src 'self' 'unsafe-inline'; img-src 'self' data:; style-src 'self' 'unsafe-inline'"`
- **Fix:** Implement nonce-based CSP without `unsafe-inline`.

### 4. Missing force_ssl in Production Config

- **File:** `config/runtime.exs` (lines 95-100)
- **Issue:** The `force_ssl` configuration with HSTS is commented out. While `fly.toml` enforces HTTPS at the proxy level, HSTS headers are not being set by the application.
- **Fix:** Uncomment `force_ssl: [hsts: true]`.

---

## Medium

### 5. Session Cookie Not Encrypted

- **File:** `lib/kanban_web/endpoint.ex` (line 7)
- **Issue:** Sessions are signed but not encrypted. A comment notes encryption is available but not configured. Sensitive data in sessions could be read if a cookie is intercepted.
- **Fix:** Add `encryption_salt` to session options.

### 6. Missing secure: true on Cookies

- **File:** `lib/kanban_web/endpoint.ex` (lines 5-10)
- **Issue:** Session and remember-me cookies don't explicitly set `secure: true`, meaning cookies could be transmitted over HTTP.
- **Fix:** Add `secure: true` to cookie options for production.

---

## Low

### 7. SameSite Cookie Policy

- **File:** `lib/kanban_web/endpoint.ex` (line 10)
- **Issue:** Uses `Lax` instead of `Strict`. Acceptable for most cases but `Strict` provides stronger CSRF protection.

---

## Moved to Stride (Goal G8)

The following items have been created as tasks in Stride under goal G8:

- **D1** — Sobelow HTTPS Check Suppressed (was #9)
- **D2** — Email Disclosure in Board Invitations (was #10)
- **D3** — Timing Attack on API Token Lookup (was #8)
- **D4** — XSS in Markdown Rendering (was #1)

---

## Areas Confirmed Secure

| Area | Status | Notes |
|------|--------|-------|
| SQL Injection | Safe | All queries use parameterized Ecto |
| Password Hashing | Safe | Bcrypt with timing-safe comparison |
| API Token Storage | Safe | SHA256 hashed, not plaintext |
| CSRF Protection | Safe | Phoenix built-in protection enabled |
| Board Authorization | Safe | Membership checked on all routes |
| API Authorization | Safe | Token + board ownership validated |
| Command Injection | Safe | No shell execution with user input |
| Path Traversal | Safe | No file operations with user-supplied paths |
| Mass Assignment | Safe | Explicit cast whitelist in changesets |
| User Enumeration (login) | Safe | Generic "Invalid email or password" message |

---

## Recommended Priority

1. **Now:** SMTP SSL verification (#1)
2. **Soon:** Add rate limiting (#2) and fix CSP (#3)
3. **Next sprint:** Enable force_ssl (#4), cookie hardening (#5, #6), and session encryption
