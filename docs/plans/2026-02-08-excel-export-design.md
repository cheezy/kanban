# Add Excel Export to Metrics Pages

## Context

The 4 metric pages (throughput, cycle time, lead time, wait time) currently only support PDF export. Users want to also export metric data as Excel spreadsheets for further analysis. The "Export to PDF" button becomes a dropdown with PDF and Excel options.

**Board types:** Metrics now work for both AI-optimized and regular (non-AI-optimized) boards. The Excel export must handle both:
- **AI-optimized boards** have `claimed_at`, `reviewed_at`, `completed_by_agent` fields on tasks, plus an agent filter.
- **Regular boards** derive timing data from TaskHistory move events. They have no agent data, no review wait section, and use "Started" instead of "Claimed" and "Queue" instead of "Backlog" labels.

The existing `MetricsPdfController` already dispatches to board-type-specific queries (e.g., `get_cycle_time_tasks_ai` vs `get_cycle_time_tasks_regular`). The Excel export reuses the same `load_metric_data/3` function, so it inherits this dispatch automatically.

## Testing Approach

Each step below includes its own tests and verification. Do not defer testing to the end. After completing each step:
1. Write tests for the code introduced in that step.
2. Run the relevant test file(s) to confirm they pass.
3. Run `mix compile --warnings-as-errors` to ensure clean compilation.
4. Only proceed to the next step after the current step's tests are green.

## Files to Modify/Create

| File | Action |
|------|--------|
| `mix.exs` | Add `{:elixlsx, "~> 0.6"}` dep |
| `lib/kanban_web/export/metrics_excel.ex` | **Create** — Excel generation module |
| `lib/kanban_web/controllers/metrics_pdf_controller.ex` | Add format dispatch + Excel response |
| `lib/kanban_web/live/metrics_live/throughput.html.heex` | Replace button with dropdown |
| `lib/kanban_web/live/metrics_live/cycle_time.html.heex` | Replace button with dropdown |
| `lib/kanban_web/live/metrics_live/lead_time.html.heex` | Replace button with dropdown |
| `lib/kanban_web/live/metrics_live/wait_time.html.heex` | Replace button with dropdown |
| `test/kanban_web/export/metrics_excel_test.exs` | **Create** — Excel unit tests |
| `test/kanban_web/controllers/metrics_pdf_controller_test.exs` | Add Excel integration tests |
| `test/kanban_web/live/metrics_live/*_test.exs` (4 files) | Update "Export to PDF" assertions |

No router changes — use `?format=excel` query param on existing route.

## Step 1: Add elixlsx dependency

In `mix.exs`, add `{:elixlsx, "~> 0.6"}` to deps. Run `mix deps.get`.

**elixlsx API summary:**
- `%Elixlsx.Sheet{name: "Sheet1", rows: [[cell, cell, ...], ...], col_widths: %{1 => 20}}`
- `%Elixlsx.Workbook{sheets: [sheet]}`
- `Elixlsx.write_to_memory(workbook, "export.xlsx")` → `{:ok, {charlist, binary}}`
- Cells: plain string/number, or `["value", bold: true]` for styled

**Verify:** `mix deps.get` succeeds, `mix compile --warnings-as-errors` clean.

## Step 2: Create `KanbanWeb.MetricsExcelExport`

**New file:** `lib/kanban_web/export/metrics_excel.ex`

Public API: `generate(board, metric, opts, data)` → `{:ok, binary}` | `{:error, reason}`

The module receives the `board` struct, so it can check `board.ai_optimized_board` to decide which columns to include and what labels to use.

### Sheet layout (all metrics)

```
Row 1: ["Throughput Metrics — My Board"]          (bold)
Row 2: ["Time Range: Last 30 Days | Weekends: Included"]
Row 3: ["Generated by Stride | Feb 8, 2026 10:30 AM"]
Row 4: (empty)
Row 5: [Column headers]                           (bold)
Row 6+: Data rows
```

For AI-optimized boards, Row 2 also includes the agent filter value (e.g., `"| Agent: All Agents"`).

### Per-metric columns — board-type aware

**Throughput — Completed Tasks section:**

| Column | AI-optimized | Regular |
|--------|-------------|---------|
| Identifier | Yes | Yes |
| Title | Yes | Yes |
| Created | Yes | Yes |
| Claimed | Yes | No |
| Completed | Yes | Yes |
| Agent | Yes | No |

Source: `data.tasks` (flat list from controller)

**Throughput — Completed Goals section** (after blank + "Completed Goals" header row):
`Identifier | Title | Created | Completed | Agent` (AI-optimized)
`Identifier | Title | Created | Completed` (Regular)
Source: `data.completed_goals`

**Cycle Time:**

| Column | AI-optimized | Regular |
|--------|-------------|---------|
| Identifier | Yes | Yes |
| Title | Yes | Yes |
| Cycle Time | Yes | Yes |
| Claimed / Started | "Claimed" | "Started" |
| Completed | Yes | Yes |
| Agent | Yes | No |

Source: `data.tasks`, field `:cycle_time_seconds` formatted via `Helpers.format_time/1`

**Lead Time:**

| Column | AI-optimized | Regular |
|--------|-------------|---------|
| Identifier | Yes | Yes |
| Title | Yes | Yes |
| Lead Time | Yes | Yes |
| Created | Yes | Yes |
| Completed | Yes | Yes |
| Agent | Yes | No |

Source: `data.tasks`, field `:lead_time_seconds`

**Wait Time — Reviewed Tasks section** (AI-optimized boards only):
`Identifier | Title | Review Wait | Completed | Reviewed | Agent`
Source: `data.grouped_review_tasks` — flatten with `Enum.flat_map(fn {_date, tasks} -> tasks end)`

For regular boards, this section is omitted entirely (no review step exists).

**Wait Time — Backlog/Queue Tasks section:**

| Column | AI-optimized | Regular |
|--------|-------------|---------|
| Section header | "Claimed Tasks" | "Started Tasks" |
| Identifier | Yes | Yes |
| Title | Yes | Yes |
| Wait column header | "Backlog Wait" | "Queue Wait" |
| Created | Yes | Yes |
| Claimed / Started | "Claimed" | "Started" |
| Agent | Yes | No |

Source: `data.grouped_backlog_tasks` — same flatten pattern

### Module structure

```elixir
defmodule KanbanWeb.MetricsExcelExport do
  alias Elixlsx.{Workbook, Sheet}
  alias KanbanWeb.MetricsLive.Helpers

  def generate(board, metric, opts, data) do
    sheet = build_sheet(board, metric, opts, data)
    workbook = %Workbook{sheets: [sheet]}

    case Elixlsx.write_to_memory(workbook, "export.xlsx") do
      {:ok, {_filename, binary}} -> {:ok, binary}
      {:error, reason} -> {:error, reason}
    end
  end

  # Private: build_sheet/4 pattern-matches on metric string
  # Private: header_rows/3 — shared rows 1-3, conditionally includes agent info
  # Private: ai_optimized?/1 — checks board.ai_optimized_board
  # Private: format_datetime_cell/1, format_time_cell/1
  # Private: per-metric builders (throughput_rows, cycle_time_rows, etc.)
  #          Each builder checks board type to decide columns/labels
end
```

Reuse `Helpers.format_time/1` for duration formatting and `Calendar.strftime/2` for datetimes.
Set reasonable column widths (Identifier: 12, Title: 40, timestamps: 22, Agent: 20, durations: 15).

### Step 2 tests

**New file:** `test/kanban_web/export/metrics_excel_test.exs`

Test `generate/4` for each metric with mock data maps matching the structure from `load_metric_data/3`. Cover both board types:

**AI-optimized board tests:**
- Returns `{:ok, binary}` with non-empty binary for each metric
- Binary starts with PK zip header (`<<0x50, 0x4B, ...>>`)
- Empty data produces valid workbook (no crash)
- Nil agent names handled gracefully

**Regular board tests:**
- Returns `{:ok, binary}` for each metric
- Throughput export works without `claimed_at` or agent data
- Cycle time export uses "Started" label context (data has `:claimed_at` key mapped from TaskHistory)
- Wait time export omits review section, uses "Queue Wait" context
- Empty data produces valid workbook

**Verify:** `mix test test/kanban_web/export/metrics_excel_test.exs` passes, `mix compile --warnings-as-errors` clean.

## Step 3: Modify MetricsPdfController for format dispatch

In `lib/kanban_web/controllers/metrics_pdf_controller.ex`:

### 3a. Update `export/2` to check format param

The current `export/2` already works for both board types (AI guard was removed). Add format dispatch:

```elixir
def export(conn, %{"id" => board_id, "metric" => metric} = params) do
  user = conn.assigns.current_scope.user
  board = Boards.get_board!(board_id, user)

  case params["format"] do
    "excel" -> generate_and_send_excel(conn, board, metric, params)
    _ -> generate_and_send_pdf(conn, board, metric, params)
  end
end
```

No AI guard — both board types are supported for both formats.

### 3b. Add Excel response functions

```elixir
defp generate_and_send_excel(conn, board, metric, params) do
  opts = build_metric_options(params)
  data = load_metric_data(metric, board.id, opts)

  case KanbanWeb.MetricsExcelExport.generate(board, metric, opts, data) do
    {:ok, excel_binary} ->
      filename = generate_filename(board, metric, opts[:time_range], ".xlsx")
      conn
      |> put_resp_content_type("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
      |> put_resp_header("content-disposition", "attachment; filename=\"#{filename}\"")
      |> send_resp(200, excel_binary)

    {:error, reason} ->
      handle_pdf_error(conn, board.id, metric, reason)  # reuse existing error handler
  end
end
```

Refactor `generate_filename/3` to accept an extension param (default `".pdf"`) so both formats reuse it.

### Step 3 tests

Add `describe "export/2 - Excel format"` to existing `metrics_pdf_controller_test.exs`:

**AI-optimized board Excel tests:**
- `test "exports throughput as Excel when format=excel"` — assert status 200, content-type spreadsheetml, .xlsx in disposition
- Same for cycle-time, lead-time, wait-time
- `test "defaults to PDF when no format specified"` — existing behavior preserved
- `test "Excel export respects filter params"` — pass time_range/agent_name, verify 200

**Regular board Excel tests:**
- `test "exports throughput as Excel for regular board"` — assert status 200, correct content-type
- `test "exports cycle-time as Excel for regular board with TaskHistory"` — set up move history, assert 200
- `test "exports wait-time as Excel for regular board"` — assert 200, no review section crash
- `test "exports Excel for regular board with empty data"` — assert 200

**Verify:** `mix test test/kanban_web/controllers/metrics_pdf_controller_test.exs` passes, `mix compile --warnings-as-errors` clean.

## Step 4: Update LiveView templates with export dropdown

Replace the "Export to PDF" `<a>` button in all 4 templates with a custom popover using the existing `Dropdown` JS hook (`assets/js/hooks/dropdown.js`, registered in `app.js`).

**Pattern** (using throughput as example, adapt metric path for others):

```heex
<div class="relative ml-2" id="export-dropdown" phx-hook="Dropdown">
  <button
    type="button"
    data-dropdown-toggle
    class="inline-flex items-center gap-2 rounded-lg bg-zinc-900 px-3 py-2
           text-sm font-semibold text-white hover:bg-zinc-700 active:text-white/80"
  >
    <.icon name="hero-arrow-down-tray" class="h-4 w-4" />
    Export
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>
  <div
    data-dropdown-menu
    class="hidden absolute right-0 top-full mt-1 bg-white dark:bg-zinc-800
           border border-gray-200 dark:border-zinc-700 rounded-lg shadow-lg
           py-1 min-w-[140px] z-50"
  >
    <a
      href={~p"/boards/#{@board}/metrics/throughput/export?time_range=#{Atom.to_string(@time_range)}&agent_name=#{@agent_name || ""}&exclude_weekends=#{to_string(@exclude_weekends)}"}
      target="_blank"
      class="flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700
             dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors"
    >
      <.icon name="hero-document" class="h-4 w-4" /> PDF
    </a>
    <a
      href={~p"/boards/#{@board}/metrics/throughput/export?format=excel&time_range=#{Atom.to_string(@time_range)}&agent_name=#{@agent_name || ""}&exclude_weekends=#{to_string(@exclude_weekends)}"}
      class="flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700
             dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors"
    >
      <.icon name="hero-table-cells" class="h-4 w-4" /> Excel
    </a>
  </div>
</div>
```

The dropdown uses `phx-hook="Dropdown"` with `data-dropdown-toggle`/`data-dropdown-menu` — same pattern as `nav_components.ex` language_switcher (line 94). The hook is in `assets/js/hooks/dropdown.js` and handles toggle + click-away.

Apply to all 4 templates, changing the metric path segment:
- `throughput.html.heex` → `throughput`
- `cycle_time.html.heex` → `cycle-time`
- `lead_time.html.heex` → `lead-time`
- `wait_time.html.heex` → `wait-time`

### Step 4 tests

In all 4 `*_test.exs` files, update tests checking for "Export to PDF". Cover both board types:

**AI-optimized board tests:**
- Assert `html =~ "Export"` (dropdown button text)
- Assert `html =~ "PDF"` and `html =~ "Excel"` (dropdown options)
- Assert `html =~ "format=excel"` (Excel link has format param)

**Regular board tests:**
- Assert `html =~ "Export"` (dropdown visible for regular boards too)
- Assert `html =~ "PDF"` and `html =~ "Excel"` (both options present)
- Assert `html =~ "format=excel"` (Excel link has format param)

**Verify:** `mix test test/kanban_web/live/metrics_live/` passes, `mix compile --warnings-as-errors` clean.

## Final Verification

After all steps are complete and individually verified:

1. `mix test` — full suite passes (confirms no regressions)
2. `mix credo` — no style issues
3. Manual: visit a metric page for both an AI-optimized board and a regular board, click Export dropdown, download Excel for each, open in spreadsheet app and verify correct columns/labels per board type
