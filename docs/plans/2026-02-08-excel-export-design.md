# Add Excel Export to Metrics Pages

## Context

The 4 metric pages (throughput, cycle time, lead time, wait time) currently only support PDF export. Users want to also export metric data as Excel spreadsheets for further analysis. The "Export to PDF" button becomes a dropdown with PDF and Excel options.

## Files to Modify/Create

| File | Action |
|------|--------|
| `mix.exs` | Add `{:elixlsx, "~> 0.6"}` dep |
| `lib/kanban_web/export/metrics_excel.ex` | **Create** — Excel generation module |
| `lib/kanban_web/controllers/metrics_pdf_controller.ex` | Add format dispatch + Excel response |
| `lib/kanban_web/live/metrics_live/throughput.html.heex` | Replace button with dropdown |
| `lib/kanban_web/live/metrics_live/cycle_time.html.heex` | Replace button with dropdown |
| `lib/kanban_web/live/metrics_live/lead_time.html.heex` | Replace button with dropdown |
| `lib/kanban_web/live/metrics_live/wait_time.html.heex` | Replace button with dropdown |
| `test/kanban_web/export/metrics_excel_test.exs` | **Create** — Excel unit tests |
| `test/kanban_web/controllers/metrics_pdf_controller_test.exs` | Add Excel integration tests |
| `test/kanban_web/live/metrics_live/*_test.exs` (4 files) | Update "Export to PDF" assertions |

No router changes — use `?format=excel` query param on existing route.

## Step 1: Add elixlsx dependency

In `mix.exs`, add `{:elixlsx, "~> 0.6"}` to deps. Run `mix deps.get`.

**elixlsx API summary:**
- `%Elixlsx.Sheet{name: "Sheet1", rows: [[cell, cell, ...], ...], col_widths: %{1 => 20}}`
- `%Elixlsx.Workbook{sheets: [sheet]}`
- `Elixlsx.write_to_memory(workbook, "export.xlsx")` → `{:ok, {charlist, binary}}`
- Cells: plain string/number, or `["value", bold: true]` for styled

## Step 2: Create `KanbanWeb.MetricsExcelExport`

**New file:** `lib/kanban_web/export/metrics_excel.ex`

Public API: `generate(board, metric, opts, data)` → `{:ok, binary}` | `{:error, reason}`

### Sheet layout (all metrics)

```
Row 1: ["Throughput Metrics — My Board"]          (bold)
Row 2: ["Time Range: Last 30 Days | Agent: All Agents | Weekends: Included"]
Row 3: ["Generated by Stride | Feb 8, 2026 10:30 AM"]
Row 4: (empty)
Row 5: [Column headers]                           (bold)
Row 6+: Data rows
```

### Per-metric columns (mirroring PDF task details)

**Throughput — Completed Tasks section:**
`Identifier | Title | Created | Claimed | Completed | Agent`
Source: `data.tasks` (flat list from controller)

**Throughput — Completed Goals section** (after blank + "Completed Goals" header row):
`Identifier | Title | Created | Completed | Agent`
Source: `data.completed_goals`

**Cycle Time:**
`Identifier | Title | Cycle Time | Claimed | Completed | Agent`
Source: `data.tasks`, field `:cycle_time_seconds` formatted via `Helpers.format_time/1`

**Lead Time:**
`Identifier | Title | Lead Time | Created | Completed | Agent`
Source: `data.tasks`, field `:lead_time_seconds`

**Wait Time — Reviewed Tasks section:**
`Identifier | Title | Review Wait | Completed | Reviewed | Agent`
Source: `data.grouped_review_tasks` — flatten with `Enum.flat_map(fn {_date, tasks} -> tasks end)`

**Wait Time — Backlog Tasks section** (after blank + "Claimed Tasks" header row):
`Identifier | Title | Backlog Wait | Created | Claimed | Agent`
Source: `data.grouped_backlog_tasks` — same flatten pattern

### Module structure

```elixir
defmodule KanbanWeb.MetricsExcelExport do
  alias Elixlsx.{Workbook, Sheet}
  alias KanbanWeb.MetricsLive.Helpers

  def generate(board, metric, opts, data) do
    sheet = build_sheet(board, metric, opts, data)
    workbook = %Workbook{sheets: [sheet]}

    case Elixlsx.write_to_memory(workbook, "export.xlsx") do
      {:ok, {_filename, binary}} -> {:ok, binary}
      {:error, reason} -> {:error, reason}
    end
  end

  # Private: build_sheet/4 pattern-matches on metric string
  # Private: header_rows/3 — shared rows 1-3
  # Private: format_datetime_cell/1, format_time_cell/1
  # Private: per-metric builders (throughput_rows, cycle_time_rows, etc.)
end
```

Reuse `Helpers.format_time/1` for duration formatting and `Calendar.strftime/2` for datetimes.
Set reasonable column widths (Identifier: 12, Title: 40, timestamps: 22, Agent: 20, durations: 15).

## Step 3: Modify MetricsPdfController for format dispatch

In `lib/kanban_web/controllers/metrics_pdf_controller.ex`:

### 3a. Update `export/2` to check format param

```elixir
def export(conn, %{"id" => board_id, "metric" => metric} = params) do
  user = conn.assigns.current_scope.user
  board = Boards.get_board!(board_id, user)

  if board.ai_optimized_board do
    case params["format"] do
      "excel" -> generate_and_send_excel(conn, board, metric, params)
      _ -> generate_and_send_pdf(conn, board, metric, params)
    end
  else
    # ... existing flash + redirect
  end
end
```

### 3b. Add Excel response functions

```elixir
defp generate_and_send_excel(conn, board, metric, params) do
  opts = build_metric_options(params)
  data = load_metric_data(metric, board.id, opts)

  case KanbanWeb.MetricsExcelExport.generate(board, metric, opts, data) do
    {:ok, excel_binary} ->
      filename = generate_filename(board, metric, opts[:time_range], ".xlsx")
      conn
      |> put_resp_content_type("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
      |> put_resp_header("content-disposition", "attachment; filename=\"#{filename}\"")
      |> send_resp(200, excel_binary)

    {:error, reason} ->
      handle_pdf_error(conn, board.id, metric, reason)  # reuse existing error handler
  end
end
```

Refactor `generate_filename/3` to accept an extension param (default `".pdf"`) so both formats reuse it.

## Step 4: Update LiveView templates with export dropdown

Replace the "Export to PDF" `<a>` button in all 4 templates with a custom popover using the existing `Dropdown` JS hook (`assets/js/hooks/dropdown.js`, registered in `app.js`).

**Pattern** (using throughput as example, adapt metric path for others):

```heex
<div class="relative ml-2" id="export-dropdown" phx-hook="Dropdown">
  <button
    type="button"
    data-dropdown-toggle
    class="inline-flex items-center gap-2 rounded-lg bg-zinc-900 px-3 py-2
           text-sm font-semibold text-white hover:bg-zinc-700 active:text-white/80"
  >
    <.icon name="hero-arrow-down-tray" class="h-4 w-4" />
    Export
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>
  <div
    data-dropdown-menu
    class="hidden absolute right-0 top-full mt-1 bg-white dark:bg-zinc-800
           border border-gray-200 dark:border-zinc-700 rounded-lg shadow-lg
           py-1 min-w-[140px] z-50"
  >
    <a
      href={~p"/boards/#{@board}/metrics/throughput/export?time_range=#{Atom.to_string(@time_range)}&agent_name=#{@agent_name || ""}&exclude_weekends=#{to_string(@exclude_weekends)}"}
      target="_blank"
      class="flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700
             dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors"
    >
      <.icon name="hero-document" class="h-4 w-4" /> PDF
    </a>
    <a
      href={~p"/boards/#{@board}/metrics/throughput/export?format=excel&time_range=#{Atom.to_string(@time_range)}&agent_name=#{@agent_name || ""}&exclude_weekends=#{to_string(@exclude_weekends)}"}
      class="flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700
             dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors"
    >
      <.icon name="hero-table-cells" class="h-4 w-4" /> Excel
    </a>
  </div>
</div>
```

The dropdown uses `phx-hook="Dropdown"` with `data-dropdown-toggle`/`data-dropdown-menu` — same pattern as `nav_components.ex` language_switcher (line 94). The hook is in `assets/js/hooks/dropdown.js` and handles toggle + click-away.

Apply to all 4 templates, changing the metric path segment:
- `throughput.html.heex` → `throughput`
- `cycle_time.html.heex` → `cycle-time`
- `lead_time.html.heex` → `lead-time`
- `wait_time.html.heex` → `wait-time`

## Step 5: Tests

### 5a. Excel unit tests (new file)

`test/kanban_web/export/metrics_excel_test.exs`

Test `generate/4` for each metric with mock data maps matching the structure from `load_metric_data/3`. Assert:
- Returns `{:ok, binary}` with non-empty binary
- Binary starts with PK zip header (`<<0x50, 0x4B, ...>>`)
- Empty data produces valid workbook (no crash)
- Nil agent names handled gracefully

### 5b. Controller integration tests

Add `describe "export/2 - Excel format"` to existing `metrics_pdf_controller_test.exs`:
- `test "exports throughput as Excel when format=excel"` — assert status 200, content-type spreadsheetml, .xlsx in disposition
- Same for cycle-time, lead-time, wait-time
- `test "defaults to PDF when no format specified"` — existing behavior preserved
- `test "Excel export respects filter params"` — pass time_range/agent_name, verify 200

### 5c. LiveView test updates

In all 4 `*_test.exs` files, update tests checking for "Export to PDF":
- Assert `html =~ "Export"` (dropdown button text)
- Assert `html =~ "PDF"` and `html =~ "Excel"` (dropdown options)
- Assert `html =~ "format=excel"` (Excel link has format param)

## Verification

1. `mix deps.get` — elixlsx installed
2. `mix compile --warnings-as-errors` — clean compile
3. `mix test test/kanban_web/export/metrics_excel_test.exs` — Excel unit tests pass
4. `mix test test/kanban_web/controllers/metrics_pdf_controller_test.exs` — controller tests pass (PDF + Excel)
5. `mix test test/kanban_web/live/metrics_live/` — LiveView tests pass with updated assertions
6. `mix test` — full suite passes
7. `mix credo` — no style issues
8. Manual: visit a metric page, click Export dropdown, download Excel, open in spreadsheet app
