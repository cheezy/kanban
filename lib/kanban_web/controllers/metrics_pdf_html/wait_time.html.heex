<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wait Time Metrics - {@board.name}</title>
    <style>
      @page {
        size: letter;
        margin: 0.75in 0.75in 1in 0.75in;

        @bottom-center {
          content: "Generated by Stride";
          font-size: 7pt;
          color: #9ca3af;
          font-family: 'Helvetica Neue', Arial, sans-serif;
        }
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        font-size: 11pt;
        line-height: 1.4;
        color: #1f2937;
      }

      .header {
        border-bottom: 3px solid #f59e0b;
        padding-bottom: 16px;
        margin-bottom: 24px;
      }

      .header h1 {
        font-size: 24pt;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .header .subtitle {
        font-size: 12pt;
        color: #6b7280;
      }

      .meta {
        display: flex;
        justify-content: space-between;
        background-color: #f3f4f6;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 24px;
        font-size: 9pt;
      }

      .meta-item {
        margin-right: 16px;
      }

      .meta-label {
        font-weight: 600;
        color: #4b5563;
      }

      .meta-value {
        color: #1f2937;
      }

      .section {
        margin-bottom: 32px;
      }

      .section-header {
        border-left: 4px solid #f59e0b;
        border-top: 4px solid #f59e0b;
        color: #1f2937;
        padding: 12px 16px;
        font-size: 14pt;
        font-weight: bold;
      }

      .section-description {
        background-color: #fffbeb;
        padding: 12px 16px;
        border-left: 4px solid #f59e0b;
        margin-bottom: 16px;
        font-size: 10pt;
        color: #4b5563;
        line-height: 1.6;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 24px;
      }

      .stat-card {
        background-color: #ffffff;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
      }

      .stat-card-blue { border-left: 4px solid #3b82f6; }
      .stat-card-purple { border-left: 4px solid #a855f7; }
      .stat-card-green { border-left: 4px solid #22c55e; }
      .stat-card-red { border-left: 4px solid #ef4444; }

      .stat-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .stat-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .stat-icon svg {
        width: 20px;
        height: 20px;
      }

      .stat-icon-blue { background-color: #dbeafe; }
      .stat-icon-purple { background-color: #f3e8ff; }
      .stat-icon-green { background-color: #dcfce7; }
      .stat-icon-red { background-color: #fee2e2; }

      .stat-label {
        font-size: 9pt;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .stat-value {
        font-size: 20pt;
        font-weight: bold;
        color: #1f2937;
        text-align: center;
      }

      .section-title {
        font-size: 14pt;
        font-weight: bold;
        color: #1f2937;
        margin-top: 24px;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }

      .task-group {
        margin-bottom: 16px;
      }

      .task-group-header {
        background-color: #fffbeb;
        border-left: 4px solid #f59e0b;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .task-group-header-indigo {
        background-color: #eef2ff;
        border-left: 4px solid #6366f1;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .task-group-date {
        font-size: 10pt;
        font-weight: bold;
        color: #1f2937;
      }

      .task-item {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        padding: 8px 12px;
        margin-bottom: 6px;
        margin-left: 12px;
        border-radius: 4px;
        page-break-inside: avoid;
      }

      .task-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .task-identifier {
        background-color: #3b82f6;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 8pt;
        font-weight: bold;
      }

      .task-title {
        font-size: 9pt;
        font-weight: 600;
        color: #1f2937;
        flex: 1;
      }

      .task-wait-time {
        background-color: #fef3c7;
        color: #92400e;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 8pt;
        font-weight: bold;
        flex-shrink: 0;
      }

      .task-wait-time-indigo {
        background-color: #e0e7ff;
        color: #3730a3;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 8pt;
        font-weight: bold;
        flex-shrink: 0;
      }

      .task-meta {
        font-size: 7pt;
        color: #9ca3af;
        margin-top: 4px;
        display: flex;
        gap: 12px;
      }

      .no-data {
        text-align: center;
        padding: 48px 24px;
        color: #6b7280;
        font-size: 12pt;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Wait Time Metrics</h1>
      <div class="subtitle">{@board.name}</div>
    </div>

    <div class="meta">
      <div>
        <span class="meta-label">Time Range:</span>
        <span class="meta-value">{format_time_range(@time_range)}</span>
      </div>
      <div>
        <span class="meta-label">Agent:</span>
        <span class="meta-value">{agent_filter_label(@agent_name)}</span>
      </div>
      <div>
        <span class="meta-label">Weekends:</span>
        <span class="meta-value">{weekend_filter_label(@exclude_weekends)}</span>
      </div>
      <div>
        <span class="meta-label">Generated:</span>
        <span class="meta-value">{format_datetime(@generated_at)}</span>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Review Wait Time</div>
      <div class="section-description">
        <strong>Review Wait Time</strong> measures how long completed tasks wait for human review.
        High review wait times indicate a human bottleneck in the workflow and can delay overall delivery.
      </div>

      <%= if @data.review_wait_stats do %>
        <div class="stats-grid">
          <div class="stat-card stat-card-blue">
            <div class="stat-header">
              <div class="stat-icon stat-icon-blue">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#2563eb">
                  <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="stat-label">Average</div>
            </div>
            <div class="stat-value">
              {format_time(@data.review_wait_stats.average_hours * 3600)}
            </div>
          </div>
          <div class="stat-card stat-card-purple">
            <div class="stat-header">
              <div class="stat-icon stat-icon-purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#9333ea">
                  <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
                </svg>
              </div>
              <div class="stat-label">Median</div>
            </div>
            <div class="stat-value">
              {format_time(@data.review_wait_stats.median_hours * 3600)}
            </div>
          </div>
          <div class="stat-card stat-card-green">
            <div class="stat-header">
              <div class="stat-icon stat-icon-green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#16a34a">
                  <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v16.19l6.22-6.22a.75.75 0 1 1 1.06 1.06l-7.5 7.5a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 1 1 1.06-1.06l6.22 6.22V3a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="stat-label">Minimum</div>
            </div>
            <div class="stat-value">{format_time(@data.review_wait_stats.min_hours * 3600)}</div>
          </div>
          <div class="stat-card stat-card-red">
            <div class="stat-header">
              <div class="stat-icon stat-icon-red">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#dc2626">
                  <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 1 1-1.06-1.06l7.5-7.5Z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="stat-label">Maximum</div>
            </div>
            <div class="stat-value">{format_time(@data.review_wait_stats.max_hours * 3600)}</div>
          </div>
        </div>
      <% else %>
        <div class="no-data">
          No review wait time data available for the selected time range.
        </div>
      <% end %>

      <%= if Map.get(@data, :grouped_review_tasks, []) != [] do %>
        <h2 class="section-title">Reviewed Tasks</h2>
        <%= for {date, day_tasks} <- Map.get(@data, :grouped_review_tasks, []) do %>
          <div class="task-group">
            <div class="task-group-header">
              <span class="task-group-date">{format_date(date)}</span>
            </div>
            <%= for task <- day_tasks do %>
              <div class="task-item">
                <div class="task-header">
                  <span class="task-identifier">{task.identifier}</span>
                  <span class="task-title">{task.title}</span>
                  <span class="task-wait-time">{format_time(task.review_wait_seconds)}</span>
                </div>
                <div class="task-meta">
                  <span>Completed: {format_datetime(task.completed_at)}</span>
                  <span>Reviewed: {format_datetime(task.reviewed_at)}</span>
                  <span>{task.completed_by_agent || "N/A"}</span>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>

    <div class="section">
      <div class="section-header">Backlog Wait Time</div>
      <div class="section-description">
        <strong>Backlog Wait Time</strong>
        measures how long tasks sit in the backlog before being claimed.
        This metric reveals how quickly work gets picked up and can indicate capacity constraints or priority alignment issues.
      </div>

      <%= if @data.backlog_wait_stats do %>
        <div class="stats-grid">
          <div class="stat-card stat-card-blue">
            <div class="stat-header">
              <div class="stat-icon stat-icon-blue">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#2563eb">
                  <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="stat-label">Average</div>
            </div>
            <div class="stat-value">
              {format_time(@data.backlog_wait_stats.average_hours * 3600)}
            </div>
          </div>
          <div class="stat-card stat-card-purple">
            <div class="stat-header">
              <div class="stat-icon stat-icon-purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#9333ea">
                  <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
                </svg>
              </div>
              <div class="stat-label">Median</div>
            </div>
            <div class="stat-value">
              {format_time(@data.backlog_wait_stats.median_hours * 3600)}
            </div>
          </div>
          <div class="stat-card stat-card-green">
            <div class="stat-header">
              <div class="stat-icon stat-icon-green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#16a34a">
                  <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v16.19l6.22-6.22a.75.75 0 1 1 1.06 1.06l-7.5 7.5a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 1 1 1.06-1.06l6.22 6.22V3a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="stat-label">Minimum</div>
            </div>
            <div class="stat-value">{format_time(@data.backlog_wait_stats.min_hours * 3600)}</div>
          </div>
          <div class="stat-card stat-card-red">
            <div class="stat-header">
              <div class="stat-icon stat-icon-red">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#dc2626">
                  <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 1 1-1.06-1.06l7.5-7.5Z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="stat-label">Maximum</div>
            </div>
            <div class="stat-value">{format_time(@data.backlog_wait_stats.max_hours * 3600)}</div>
          </div>
        </div>
      <% else %>
        <div class="no-data">
          No backlog wait time data available for the selected time range.
        </div>
      <% end %>

      <%= if Map.get(@data, :grouped_backlog_tasks, []) != [] do %>
        <h2 class="section-title">Claimed Tasks</h2>
        <%= for {date, day_tasks} <- Map.get(@data, :grouped_backlog_tasks, []) do %>
          <div class="task-group">
            <div class="task-group-header-indigo">
              <span class="task-group-date">{format_date(date)}</span>
            </div>
            <%= for task <- day_tasks do %>
              <div class="task-item">
                <div class="task-header">
                  <span class="task-identifier">{task.identifier}</span>
                  <span class="task-title">{task.title}</span>
                  <span class="task-wait-time-indigo">{format_time(task.backlog_wait_seconds)}</span>
                </div>
                <div class="task-meta">
                  <span>Created: {format_datetime(task.inserted_at)}</span>
                  <span>Claimed: {format_datetime(task.claimed_at)}</span>
                  <span>{task.completed_by_agent || "N/A"}</span>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </body>
</html>
