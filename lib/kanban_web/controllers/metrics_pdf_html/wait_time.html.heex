<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wait Time Metrics - {@board.name}</title>
    {Phoenix.HTML.raw("<style>" <> shared_pdf_css() <> "</style>")}
    <style>
      .header { border-bottom: 3px solid #f59e0b; }

      .section { margin-bottom: 32px; }

      .section-header {
        border-left: 4px solid #f59e0b;
        border-top: 4px solid #f59e0b;
        color: #1f2937;
        padding: 12px 16px;
        font-size: 14pt;
        font-weight: bold;
      }

      .section-description {
        background-color: #fffbeb;
        padding: 12px 16px;
        border-left: 4px solid #f59e0b;
        margin-bottom: 16px;
        font-size: 10pt;
        color: #4b5563;
        line-height: 1.6;
      }

      .task-group-header {
        background-color: #fffbeb;
        border-left: 4px solid #f59e0b;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .task-group-header-indigo {
        background-color: #eef2ff;
        border-left: 4px solid #6366f1;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .task-wait-time {
        background-color: #fef3c7;
        color: #92400e;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 8pt;
        font-weight: bold;
        flex-shrink: 0;
      }

      .task-wait-time-indigo {
        background-color: #e0e7ff;
        color: #3730a3;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 8pt;
        font-weight: bold;
        flex-shrink: 0;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Wait Time Metrics</h1>
      <div class="subtitle">{@board.name}</div>
    </div>

    <div class="meta">
      <div>
        <span class="meta-label">Time Range:</span>
        <span class="meta-value">{format_time_range(@time_range)}</span>
      </div>
      <div>
        <span class="meta-label">Agent:</span>
        <span class="meta-value">{agent_filter_label(@agent_name)}</span>
      </div>
      <div>
        <span class="meta-label">Weekends:</span>
        <span class="meta-value">{weekend_filter_label(@exclude_weekends)}</span>
      </div>
      <div>
        <span class="meta-label">Generated:</span>
        <span class="meta-value">{format_datetime(@generated_at)}</span>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Review Wait Time</div>
      <div class="section-description">
        <strong>Review Wait Time</strong> measures how long completed tasks wait for human review.
        High review wait times indicate a human bottleneck in the workflow and can delay overall delivery.
      </div>

      <%= if @data.review_wait_stats do %>
        <div class="stats-grid">
          <div class="stat-card stat-card-blue">
            <div class="stat-header">
              <div class="stat-icon stat-icon-blue">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#2563eb">
                  <path
                    fill-rule="evenodd"
                    d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <div class="stat-label">Average</div>
            </div>
            <div class="stat-value">
              {format_time(@data.review_wait_stats.average_hours * 3600)}
            </div>
          </div>
          <div class="stat-card stat-card-purple">
            <div class="stat-header">
              <div class="stat-icon stat-icon-purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#9333ea">
                  <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
                </svg>
              </div>
              <div class="stat-label">Median</div>
            </div>
            <div class="stat-value">
              {format_time(@data.review_wait_stats.median_hours * 3600)}
            </div>
          </div>
          <div class="stat-card stat-card-green">
            <div class="stat-header">
              <div class="stat-icon stat-icon-green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#16a34a">
                  <path
                    fill-rule="evenodd"
                    d="M12 2.25a.75.75 0 0 1 .75.75v16.19l6.22-6.22a.75.75 0 1 1 1.06 1.06l-7.5 7.5a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 1 1 1.06-1.06l6.22 6.22V3a.75.75 0 0 1 .75-.75Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <div class="stat-label">Minimum</div>
            </div>
            <div class="stat-value">{format_time(@data.review_wait_stats.min_hours * 3600)}</div>
          </div>
          <div class="stat-card stat-card-red">
            <div class="stat-header">
              <div class="stat-icon stat-icon-red">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#dc2626">
                  <path
                    fill-rule="evenodd"
                    d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 1 1-1.06-1.06l7.5-7.5Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <div class="stat-label">Maximum</div>
            </div>
            <div class="stat-value">{format_time(@data.review_wait_stats.max_hours * 3600)}</div>
          </div>
        </div>
      <% else %>
        <div class="no-data">
          No review wait time data available for the selected time range.
        </div>
      <% end %>

      <%= if Map.get(@data, :grouped_review_tasks, []) != [] do %>
        <h2 class="section-title">Reviewed Tasks</h2>
        <%= for {date, day_tasks} <- Map.get(@data, :grouped_review_tasks, []) do %>
          <div class="task-group">
            <div class="task-group-header">
              <span class="task-group-date">{format_date(date)}</span>
            </div>
            <%= for task <- day_tasks do %>
              <div class="task-item">
                <div class="task-header">
                  <span class="task-identifier">{task.identifier}</span>
                  <span class="task-title">{task.title}</span>
                  <span class="task-wait-time">{format_time(task.review_wait_seconds)}</span>
                </div>
                <div class="task-meta">
                  <span>Completed: {format_datetime(task.completed_at)}</span>
                  <span>Reviewed: {format_datetime(task.reviewed_at)}</span>
                  <span>{task.completed_by_agent || "N/A"}</span>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>

    <div class="section">
      <div class="section-header">Backlog Wait Time</div>
      <div class="section-description">
        <strong>Backlog Wait Time</strong>
        measures how long tasks sit in the backlog before being claimed.
        This metric reveals how quickly work gets picked up and can indicate capacity constraints or priority alignment issues.
      </div>

      <%= if @data.backlog_wait_stats do %>
        <div class="stats-grid">
          <div class="stat-card stat-card-blue">
            <div class="stat-header">
              <div class="stat-icon stat-icon-blue">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#2563eb">
                  <path
                    fill-rule="evenodd"
                    d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <div class="stat-label">Average</div>
            </div>
            <div class="stat-value">
              {format_time(@data.backlog_wait_stats.average_hours * 3600)}
            </div>
          </div>
          <div class="stat-card stat-card-purple">
            <div class="stat-header">
              <div class="stat-icon stat-icon-purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#9333ea">
                  <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
                </svg>
              </div>
              <div class="stat-label">Median</div>
            </div>
            <div class="stat-value">
              {format_time(@data.backlog_wait_stats.median_hours * 3600)}
            </div>
          </div>
          <div class="stat-card stat-card-green">
            <div class="stat-header">
              <div class="stat-icon stat-icon-green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#16a34a">
                  <path
                    fill-rule="evenodd"
                    d="M12 2.25a.75.75 0 0 1 .75.75v16.19l6.22-6.22a.75.75 0 1 1 1.06 1.06l-7.5 7.5a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 1 1 1.06-1.06l6.22 6.22V3a.75.75 0 0 1 .75-.75Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <div class="stat-label">Minimum</div>
            </div>
            <div class="stat-value">{format_time(@data.backlog_wait_stats.min_hours * 3600)}</div>
          </div>
          <div class="stat-card stat-card-red">
            <div class="stat-header">
              <div class="stat-icon stat-icon-red">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#dc2626">
                  <path
                    fill-rule="evenodd"
                    d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 1 1-1.06-1.06l7.5-7.5Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <div class="stat-label">Maximum</div>
            </div>
            <div class="stat-value">{format_time(@data.backlog_wait_stats.max_hours * 3600)}</div>
          </div>
        </div>
      <% else %>
        <div class="no-data">
          No backlog wait time data available for the selected time range.
        </div>
      <% end %>

      <%= if Map.get(@data, :grouped_backlog_tasks, []) != [] do %>
        <h2 class="section-title">Claimed Tasks</h2>
        <%= for {date, day_tasks} <- Map.get(@data, :grouped_backlog_tasks, []) do %>
          <div class="task-group">
            <div class="task-group-header-indigo">
              <span class="task-group-date">{format_date(date)}</span>
            </div>
            <%= for task <- day_tasks do %>
              <div class="task-item">
                <div class="task-header">
                  <span class="task-identifier">{task.identifier}</span>
                  <span class="task-title">{task.title}</span>
                  <span class="task-wait-time-indigo">
                    {format_time(task.backlog_wait_seconds)}
                  </span>
                </div>
                <div class="task-meta">
                  <span>Created: {format_datetime(task.inserted_at)}</span>
                  <span>Claimed: {format_datetime(task.claimed_at)}</span>
                  <span>{task.completed_by_agent || "N/A"}</span>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </body>
</html>
