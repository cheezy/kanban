<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Throughput Metrics - {@board.name}</title>
    {Phoenix.HTML.raw("<style>" <> shared_pdf_css() <> "</style>")}
    <style>
      .header { border-bottom: 3px solid #3b82f6; }

      .chart {
        margin-bottom: 24px;
      }

      .chart-bar {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        page-break-inside: avoid;
      }

      .chart-date {
        width: 100px;
        font-size: 9pt;
        color: #4b5563;
        text-align: right;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .chart-bar-container {
        flex: 1;
        background-color: #f3f4f6;
        height: 32px;
        border-radius: 4px;
        overflow: hidden;
      }

      .chart-bar-fill {
        background-color: #2563eb;
        height: 100%;
        min-width: 8px;
      }

      .chart-count {
        width: 60px;
        text-align: right;
        font-size: 9pt;
        font-weight: 600;
        color: #1f2937;
        margin-left: 12px;
        flex-shrink: 0;
      }

      .goal-item {
        background-color: #faf5ff;
        border-left: 4px solid #9333ea;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        page-break-inside: avoid;
      }

      .goal-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .goal-identifier {
        background-color: #9333ea;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 8pt;
        font-weight: bold;
      }

      .goal-title {
        font-size: 10pt;
        font-weight: 600;
        color: #1f2937;
        flex: 1;
      }

      .goal-meta {
        font-size: 8pt;
        color: #6b7280;
        margin-top: 4px;
      }

      .task-group-header {
        background-color: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .task-group-count {
        font-size: 8pt;
        color: #6b7280;
      }

      .task-agent {
        font-size: 8pt;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Throughput Metrics</h1>
      <div class="subtitle">{@board.name}</div>
    </div>

    <div class="meta">
      <div>
        <span class="meta-label">Time Range:</span>
        <span class="meta-value">{format_time_range(@time_range)}</span>
      </div>
      <div>
        <span class="meta-label">Agent:</span>
        <span class="meta-value">{agent_filter_label(@agent_name)}</span>
      </div>
      <div>
        <span class="meta-label">Weekends:</span>
        <span class="meta-value">{weekend_filter_label(@exclude_weekends)}</span>
      </div>
      <div>
        <span class="meta-label">Generated:</span>
        <span class="meta-value">{format_datetime(@generated_at)}</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card stat-card-blue">
        <div class="stat-header">
          <div class="stat-icon stat-icon-blue">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="#2563eb"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
              />
            </svg>
          </div>
          <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-value">{@data.summary_stats.total}</div>
      </div>
      <div class="stat-card stat-card-green">
        <div class="stat-header">
          <div class="stat-icon stat-icon-green">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="#16a34a"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25Z"
              />
            </svg>
          </div>
          <div class="stat-label">Avg Per Day</div>
        </div>
        <div class="stat-value">{@data.summary_stats.avg_per_day}</div>
      </div>
      <div class="stat-card stat-card-purple">
        <div class="stat-header">
          <div class="stat-icon stat-icon-purple">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="#9333ea"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
              />
            </svg>
          </div>
          <div class="stat-label">Peak Day</div>
        </div>
        <div class="stat-value">{format_date(@data.summary_stats.peak_day)}</div>
      </div>
      <div class="stat-card stat-card-amber">
        <div class="stat-header">
          <div class="stat-icon stat-icon-amber">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="#d97706"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0"
              />
            </svg>
          </div>
          <div class="stat-label">Peak Count</div>
        </div>
        <div class="stat-value">{@data.summary_stats.peak_count}</div>
      </div>
    </div>

    <%= if @data.throughput != [] do %>
      <h2 class="section-title">Daily Throughput</h2>
      <div class="chart">
        <%= for day <- @data.throughput do %>
          <div class="chart-bar">
            <div class="chart-date">{format_date(day.date)}</div>
            <div class="chart-bar-container">
              <div
                class="chart-bar-fill"
                style={"width: #{calculate_bar_width(day.count, @data.summary_stats.peak_count)}%; min-width: 8px; background-color: #2563eb; height: 32px; display: block;"}
              >
                &nbsp;
              </div>
            </div>
            <div class="chart-count">{day.count} tasks</div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="no-data">
        No throughput data available for the selected time range.
      </div>
    <% end %>

    <%= if Map.get(@data, :completed_goals, []) != [] do %>
      <h2 class="section-title">Completed Goals</h2>
      <%= for goal <- Map.get(@data, :completed_goals, []) do %>
        <div class="goal-item">
          <div class="goal-header">
            <span class="goal-identifier">{goal.identifier}</span>
            <span class="goal-title">{goal.title}</span>
          </div>
          <div class="goal-meta">
            Completed: {format_datetime(goal.completed_at)} •
            Created: {format_datetime(goal.inserted_at)}
            <%= if goal.completed_by_agent do %>
              • Agent: {goal.completed_by_agent}
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>

    <%= if Map.get(@data, :grouped_tasks, []) != [] do %>
      <h2 class="section-title">Completed Tasks</h2>
      <%= for {date, day_tasks} <- Map.get(@data, :grouped_tasks, []) do %>
        <div class="task-group">
          <div class="task-group-header">
            <span class="task-group-date">{format_date(date)}</span>
            <span class="task-group-count">
              {length(day_tasks)} {if length(day_tasks) == 1, do: "task", else: "tasks"}
            </span>
          </div>
          <%= for task <- day_tasks do %>
            <div class="task-item">
              <div class="task-header">
                <span class="task-identifier">{task.identifier}</span>
                <span class="task-title">{task.title}</span>
                <%= if task.completed_by_agent do %>
                  <span class="task-agent">{task.completed_by_agent}</span>
                <% end %>
              </div>
              <div class="task-meta">
                <span>Created: {format_datetime(task.inserted_at)}</span>
                <%= if task.claimed_at do %>
                  <span>Claimed: {format_datetime(task.claimed_at)}</span>
                <% end %>
                <span>Completed: {format_datetime(task.completed_at)}</span>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </body>
</html>
