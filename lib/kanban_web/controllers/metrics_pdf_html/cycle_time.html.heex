<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cycle Time Metrics - {@board.name}</title>
    {Phoenix.HTML.raw("<style>" <> shared_pdf_css() <> "</style>")}
    <style>
      .header { border-bottom: 3px solid #8b5cf6; }

      .description {
        background-color: #faf5ff;
        border-left: 4px solid #8b5cf6;
        padding: 16px;
        margin-bottom: 24px;
        border-radius: 4px;
      }

      .description-text {
        font-size: 10pt;
        color: #4b5563;
        line-height: 1.6;
      }

      .chart-container {
        margin-bottom: 24px;
        page-break-inside: avoid;
      }

      .chart-x-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
        padding: 0 0 0 40px;
        font-size: 7pt;
        color: #6b7280;
      }

      .task-group-header {
        background-color: #faf5ff;
        border-left: 4px solid #8b5cf6;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .task-cycle-time {
        background-color: #f3e8ff;
        color: #7c3aed;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 8pt;
        font-weight: bold;
        flex-shrink: 0;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Cycle Time Metrics</h1>
      <div class="subtitle">{@board.name}</div>
    </div>

    <div class="meta">
      <div>
        <span class="meta-label">Time Range:</span>
        <span class="meta-value">{format_time_range(@time_range)}</span>
      </div>
      <div>
        <span class="meta-label">Agent:</span>
        <span class="meta-value">{agent_filter_label(@agent_name)}</span>
      </div>
      <div>
        <span class="meta-label">Weekends:</span>
        <span class="meta-value">{weekend_filter_label(@exclude_weekends)}</span>
      </div>
      <div>
        <span class="meta-label">Generated:</span>
        <span class="meta-value">{format_datetime(@generated_at)}</span>
      </div>
    </div>

    <div class="description">
      <div class="description-text">
        <strong>Cycle Time</strong>
        measures the time from when work starts (task claimed) until completion.
        This metric helps identify how long active work takes and is crucial for capacity planning and sprint estimation.
      </div>
    </div>

    <%= if @data.summary_stats do %>
      <div class="stats-grid">
        <div class="stat-card stat-card-blue">
          <div class="stat-header">
            <div class="stat-icon stat-icon-blue">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#2563eb">
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="stat-label">Average</div>
          </div>
          <div class="stat-value">{format_time(@data.summary_stats.average_hours * 3600)}</div>
        </div>
        <div class="stat-card stat-card-purple">
          <div class="stat-header">
            <div class="stat-icon stat-icon-purple">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#9333ea">
                <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
              </svg>
            </div>
            <div class="stat-label">Median</div>
          </div>
          <div class="stat-value">{format_time(@data.summary_stats.median_hours * 3600)}</div>
        </div>
        <div class="stat-card stat-card-green">
          <div class="stat-header">
            <div class="stat-icon stat-icon-green">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#16a34a">
                <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v16.19l6.22-6.22a.75.75 0 1 1 1.06 1.06l-7.5 7.5a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 1 1 1.06-1.06l6.22 6.22V3a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="stat-label">Minimum</div>
          </div>
          <div class="stat-value">{format_time(@data.summary_stats.min_hours * 3600)}</div>
        </div>
        <div class="stat-card stat-card-red">
          <div class="stat-header">
            <div class="stat-icon stat-icon-red">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#dc2626">
                <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 1 1-1.06-1.06l7.5-7.5Z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="stat-label">Maximum</div>
          </div>
          <div class="stat-value">{format_time(@data.summary_stats.max_hours * 3600)}</div>
        </div>
      </div>
    <% else %>
      <div class="no-data">
        No cycle time data available for the selected time range.
      </div>
    <% end %>

    <%= if Map.get(@data, :daily_cycle_times, []) != [] do %>
      <h2 class="section-title">Cycle Time Trend</h2>
      <%
        chart_w = 560
        chart_h = 200
        sorted_times = Enum.sort_by(@data.daily_cycle_times, & &1.date, Date)
        max_hours = sorted_times |> Enum.map(& &1.average_hours) |> Enum.max(fn -> 0 end)
        max_val = if max_hours == 0, do: 1.0, else: max_hours * 1.1
        points = line_chart_points(sorted_times, chart_w, chart_h, max_val)
        polyline = points_to_polyline(points)
        y_labels = line_chart_y_labels(max_val, 5)
        x_label_count = min(length(sorted_times), 8)
        x_step = if length(sorted_times) > 1, do: div(length(sorted_times) - 1, x_label_count - 1), else: 1
        x_label_indices = if length(sorted_times) > 1,
          do: Enum.take_every(0..(length(sorted_times) - 1), x_step) |> Enum.take(x_label_count),
          else: [0]
      %>
      <div class="chart-container">
        <svg width="620" height={"#{chart_h + 30}"} viewBox={"0 0 620 #{chart_h + 30}"} xmlns="http://www.w3.org/2000/svg">
          <g transform="translate(45, 5)">
            <!-- Y-axis grid lines and labels -->
            <%= for val <- y_labels do %>
              <% y = chart_h - val / max_val * chart_h %>
              <line x1="0" y1={Float.round(y * 1.0, 1)} x2={chart_w} y2={Float.round(y * 1.0, 1)} stroke="#e5e7eb" stroke-width="1" />
              <text x="-8" y={Float.round(y * 1.0 + 3, 1)} text-anchor="end" font-size="7pt" fill="#6b7280">
                {format_time(val * 3600)}
              </text>
            <% end %>

            <!-- Area fill under the line -->
            <polygon
              points={"0,#{chart_h} #{polyline} #{elem(List.last(points), 0)},#{chart_h}"}
              fill="#8b5cf6"
              fill-opacity="0.1"
            />

            <!-- The line itself -->
            <polyline
              points={polyline}
              fill="none"
              stroke="#8b5cf6"
              stroke-width="2.5"
              stroke-linejoin="round"
              stroke-linecap="round"
            />

            <!-- Data points -->
            <%= for {x, y} <- points do %>
              <circle cx={x} cy={y} r="3" fill="#8b5cf6" />
            <% end %>
          </g>
        </svg>
        <div class="chart-x-labels">
          <%= for i <- x_label_indices do %>
            <span>{format_short_date(Enum.at(sorted_times, i).date)}</span>
          <% end %>
        </div>
      </div>
    <% end %>

    <%= if Map.get(@data, :grouped_tasks, []) != [] do %>
      <h2 class="section-title">Completed Tasks</h2>
      <%= for {date, day_tasks} <- Map.get(@data, :grouped_tasks, []) do %>
        <div class="task-group">
          <div class="task-group-header">
            <span class="task-group-date">{format_date(date)}</span>
          </div>
          <%= for task <- day_tasks do %>
            <div class="task-item">
              <div class="task-header">
                <span class="task-identifier">{task.identifier}</span>
                <span class="task-title">{task.title}</span>
                <span class="task-cycle-time">{format_time(task.cycle_time_seconds)}</span>
              </div>
              <div class="task-meta">
                <span>Claimed: {format_datetime(task.claimed_at)}</span>
                <span>Completed: {format_datetime(task.completed_at)}</span>
                <span>{task.completed_by_agent || "N/A"}</span>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </body>
</html>
