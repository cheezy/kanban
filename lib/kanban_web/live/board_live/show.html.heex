<Layouts.app flash={@flash} current_scope={@current_scope}>
  <div class="mx-auto max-w-[1920px] px-4 py-8 sm:px-6 lg:px-8">
    <.header>
      {@board.name}
      <:subtitle>{@board.description}</:subtitle>
      <:actions>
        <.link :if={@user_access == :owner and not @board.ai_optimized_board} patch={~p"/boards/#{@board}/columns/new"}>
          <.button>{gettext("New Column")}</.button>
        </.link>
        <.link :if={@can_modify and @board.ai_optimized_board} patch={~p"/boards/#{@board}/api_tokens"}>
          <.button>{gettext("API Tokens")}</.button>
        </.link>
        <.link :if={@user_access == :owner} navigate={~p"/boards/#{@board}/edit"}>
          <.button>{gettext("Edit board")}</.button>
        </.link>
        <.link navigate={~p"/boards"}>
          <.button>{gettext("Back to boards")}</.button>
        </.link>
      </:actions>
    </.header>

    <div class="mt-8">
      <%= if !@has_columns do %>
        <div class="p-12 bg-gradient-to-br from-base-100 to-base-200 rounded-xl border-2 border-dashed border-base-300 shadow-sm">
          <div class="text-center max-w-md mx-auto">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 mb-6">
              <.icon name="hero-queue-list" class="h-10 w-10 text-blue-600" />
            </div>
            <h2 class="text-2xl font-bold text-base-content mb-2">{gettext("No columns yet")}</h2>
            <p class="text-base text-base-content opacity-70 mb-8 leading-relaxed">
              {gettext("Get started by creating columns for your board.")}
            </p>
            <div :if={@user_access == :owner and not @board.ai_optimized_board}>
              <.link patch={~p"/boards/#{@board}/columns/new"}>
                <.button>{gettext("Create your first column")}</.button>
              </.link>
            </div>
          </div>
        </div>
      <% else %>
        <div
          class="flex gap-4 overflow-x-auto pb-4"
          id="columns"
          phx-update="stream"
          phx-hook="ColumnSortable"
          data-responsive-columns="true"
        >
          <div
            :for={{id, column} <- @streams.columns}
            id={id}
            class="flex-shrink-0 w-72 bg-gradient-to-br from-base-200 to-base-300/80 rounded-xl p-4 shadow-sm border border-base-300/50"
            data-column-id={column.id}
          >
            <% task_count = Map.get(@tasks_by_column, column.id, []) |> length() %>
            <% at_limit = column.wip_limit > 0 and task_count >= column.wip_limit %>
            <% over_limit = column.wip_limit > 0 and task_count > column.wip_limit %>
            <div class="flex items-start justify-between mb-4 pb-3 border-b border-base-300/60 group">
              <%= if @user_access == :owner and not @board.ai_optimized_board do %>
                <div class="flex items-center gap-2 column-drag-handle cursor-grab active:cursor-grabbing mr-2 opacity-40 group-hover:opacity-100 transition-opacity">
                  <.icon name="hero-bars-3" class="h-5 w-5 text-base-content" />
                </div>
              <% end %>
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <h2 class="font-bold text-base-content text-base">{translate_column_name(column.name)}</h2>
                  <%= if over_limit do %>
                    <span
                      title={gettext("WIP limit exceeded")}
                      class="flex items-center justify-center w-6 h-6 rounded-full bg-red-100 animate-pulse"
                    >
                      <.icon name="hero-exclamation-triangle-solid" class="h-4 w-4 text-red-600" />
                    </span>
                  <% else %>
                    <%= if @can_modify do %>
                      <%= if at_limit do %>
                        <span
                          title={gettext("WIP limit reached")}
                          class="flex items-center justify-center w-6 h-6 rounded-full bg-base-200"
                        >
                          <.icon
                            name="hero-plus-circle-solid"
                            class="h-5 w-5 text-base-content opacity-40 cursor-not-allowed"
                          />
                        </span>
                      <% else %>
                        <.link
                          patch={~p"/boards/#{@board}/columns/#{column}/tasks/new"}
                          title={gettext("Add task")}
                          class="flex items-center justify-center w-6 h-6 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 hover:from-green-200 hover:to-emerald-200 transition-all hover:scale-110"
                        >
                          <.icon
                            name="hero-plus-circle-solid"
                            class="h-5 w-5 text-green-600"
                          />
                        </.link>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
                <div class="mt-2 flex items-center gap-2">
                  <span class="text-xs text-base-content opacity-70 bg-base-100/60 px-2.5 py-1 rounded-full font-medium border border-base-300/50">
                    {gettext("Tasks")}:
                    <span class="font-bold text-base-content">{task_count}</span>
                  </span>
                  <%= if column.wip_limit > 0 do %>
                    <span class={[
                      "text-xs px-2.5 py-1 rounded-full font-medium border shadow-sm",
                      (over_limit &&
                         "bg-gradient-to-r from-red-50 to-red-100 text-red-700 border-red-200/50") ||
                        "bg-gradient-to-r from-blue-50 to-blue-100 text-blue-700 border-blue-200/50"
                    ]}>
                      {gettext("WIP")}: {column.wip_limit}
                    </span>
                  <% end %>
                </div>
              </div>
              <%= if @user_access == :owner and not @board.ai_optimized_board do %>
                <div class="flex gap-1.5">
                  <.link
                    patch={~p"/boards/#{@board}/columns/#{column}/edit"}
                    aria-label={gettext("Edit column")}
                    class="p-1.5 bg-base-100/90 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-md transition-all shadow-sm opacity-0 group-hover:opacity-100"
                  >
                    <.icon
                      name="hero-pencil-solid"
                      class="h-4 w-4 text-base-content opacity-50 hover:text-blue-600 transition-colors"
                    />
                  </.link>
                  <.link
                    phx-click={JS.push("delete_column", value: %{id: column.id})}
                    data-confirm={
                      gettext(
                        "Are you sure you want to delete this column? All tasks in this column will also be deleted."
                      )
                    }
                    aria-label={gettext("Delete column")}
                    class="p-1.5 bg-base-100/90 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-md transition-all shadow-sm phx-submit-loading:opacity-50 phx-submit-loading:cursor-wait opacity-0 group-hover:opacity-100"
                  >
                    <.icon
                      name="hero-trash-solid"
                      class="h-4 w-4 text-base-content opacity-50 hover:text-red-600 transition-colors phx-submit-loading:animate-pulse"
                    />
                  </.link>
                </div>
              <% end %>
            </div>

            <div
              class="space-y-2 min-h-[100px] p-1 rounded transition-colors"
              id={"tasks-#{column.id}"}
              phx-hook="Sortable"
              data-column-id={column.id}
              data-version={@tasks_version}
              data-group="tasks"
              data-handle=".drag-handle"
              data-wip-limit={column.wip_limit}
              data-task-count={task_count}
            >
              <div
                id={"empty-state-#{column.id}"}
                class={"p-6 bg-gradient-to-br from-base-100 to-base-200 rounded-lg border-2 border-dashed border-base-300 empty-state text-center #{if task_count > 0, do: "hidden"}"}
              >
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-base-200 mb-3">
                  <.icon name="hero-inbox" class="h-6 w-6 text-base-content opacity-40" />
                </div>
                <p class="text-sm font-medium text-base-content opacity-70 mb-1">
                  {gettext("No tasks yet")}
                </p>
                <p class="text-xs text-base-content opacity-60">
                  {gettext("Drag tasks here or click + to add")}
                </p>
              </div>

              <%= for task <- Map.get(@tasks_by_column, column.id, []) do %>
                <div
                  id={"task-#{task.id}"}
                  class={[
                    "group task-card p-3 bg-gradient-to-br from-base-100 to-base-200/50 rounded-lg shadow-md hover:shadow-xl border border-base-300/60 hover:border-blue-300/50 transition-all duration-200 transform hover:-translate-y-0.5 relative overflow-hidden",
                    @can_modify && "cursor-move",
                    task.assigned_to_id == @current_scope.user.id &&
                      "border-l-4 border-l-green-500",
                    is_nil(task.assigned_to_id) && "border-l-4 border-l-yellow-500"
                  ]}
                  data-id={task.id}
                >
                  <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-50/40 to-purple-50/40 dark:from-blue-900/20 dark:to-purple-900/20 rounded-full blur-xl -z-10 group-hover:from-blue-100/50 group-hover:to-purple-100/50 dark:group-hover:from-blue-800/30 dark:group-hover:to-purple-800/30 transition-all duration-200">
                  </div>
                  <%= if @can_modify do %>
                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                      <.link
                        patch={~p"/boards/#{@board}/tasks/#{task}/edit"}
                        aria-label={gettext("Edit task")}
                        class="p-1.5 bg-base-100/90 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-md transition-colors shadow-sm"
                      >
                        <.icon
                          name="hero-pencil-solid"
                          class="h-4 w-4 text-base-content opacity-50 hover:text-blue-600 transition-colors"
                        />
                      </.link>
                      <.link
                        phx-click={JS.push("delete_task", value: %{id: task.id})}
                        data-confirm={gettext("Are you sure you want to delete this task?")}
                        aria-label={gettext("Delete task")}
                        class="p-1.5 bg-base-100/90 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-md transition-colors shadow-sm phx-submit-loading:opacity-50 phx-submit-loading:cursor-wait"
                      >
                        <.icon
                          name="hero-trash-solid"
                          class="h-4 w-4 text-base-content opacity-50 hover:text-red-600 transition-colors phx-submit-loading:animate-pulse"
                        />
                      </.link>
                    </div>
                  <% end %>
                  <div class="flex items-start gap-2">
                    <%= if @can_modify do %>
                      <div class="drag-handle cursor-grab active:cursor-grabbing pt-1 opacity-40 group-hover:opacity-100 transition-opacity flex-shrink-0">
                        <.icon name="hero-bars-3" class="h-4 w-4 text-base-content" />
                      </div>
                    <% end %>
                    <div
                      phx-click="view_task"
                      phx-value-id={task.id}
                      class="flex-1 cursor-pointer hover:bg-blue-50/30 dark:hover:bg-blue-900/20 rounded-md -m-1 p-1.5 transition-colors duration-150 min-w-0"
                    >
                      <div>
                        <h3 class="font-semibold text-base-content text-sm leading-snug group-hover:text-blue-600 transition-colors pr-16">
                          {task.title}
                        </h3>
                        <%= if task.description && task.description != "" do %>
                          <p class="mt-1.5 text-xs text-base-content opacity-70 line-clamp-2 leading-relaxed">
                            {task.description}
                          </p>
                        <% end %>
                        <div class="mt-3 flex items-center justify-between flex-wrap gap-2">
                          <div class="flex gap-1.5 flex-wrap">
                            <span
                              class={[
                                "inline-flex items-center px-2 py-1 rounded-md text-xs font-medium shadow-sm transition-transform hover:scale-105",
                                (task.type == :defect &&
                                   "bg-gradient-to-r from-red-50 to-red-100 text-red-700 border border-red-200/50") ||
                                  "bg-gradient-to-r from-blue-50 to-blue-100 text-blue-700 border border-blue-200/50"
                              ]}
                              title={
                                if task.type == :defect,
                                  do: gettext("Defect"),
                                  else: gettext("Work")
                              }
                            >
                              <%= if task.type == :defect do %>
                                <.icon name="hero-bug-ant" class="h-3.5 w-3.5" />
                              <% else %>
                                <.icon name="hero-wrench-screwdriver" class="h-3.5 w-3.5" />
                              <% end %>
                            </span>
                            <span class={[
                              "inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium shadow-sm transition-transform hover:scale-105 border",
                              case task.priority do
                                :critical ->
                                  "bg-gradient-to-r from-red-50 to-red-100 text-red-700 border-red-200/50"

                                :high ->
                                  "bg-gradient-to-r from-orange-50 to-orange-100 text-orange-700 border-orange-200/50"

                                :medium ->
                                  "bg-gradient-to-r from-yellow-50 to-yellow-100 text-yellow-700 border-yellow-200/50"

                                :low ->
                                  "bg-gradient-to-r from-green-50 to-green-100 text-green-700 border-green-200/50"
                              end
                            ]}>
                              {case task.priority do
                                :critical -> gettext("Critical")
                                :high -> gettext("High")
                                :medium -> gettext("Medium")
                                :low -> gettext("Low")
                              end}
                            </span>
                          </div>
                          <div class="flex items-center gap-2">
                            <%= if task.assigned_to do %>
                              <span
                                class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 border border-blue-200/50 transition-transform hover:scale-110"
                                title={task.assigned_to.name || task.assigned_to.email}
                              >
                                <.icon
                                  name="hero-user-solid"
                                  class="h-3.5 w-3.5 text-blue-600"
                                />
                              </span>
                            <% end %>
                            <span class="text-xs font-bold text-base-content opacity-60 bg-base-200/80 px-2 py-0.5 rounded-full">
                              {task.identifier}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <KanbanWeb.DelayedModal.delayed_modal
    :if={@live_action in [:new_column, :edit_column]}
    id="column-modal"
    show
    on_cancel={JS.patch(~p"/boards/#{@board}")}
  >
    <.live_component
      module={KanbanWeb.ColumnLive.FormComponent}
      id={(@live_action == :new_column && :new) || "edit-#{@column.id}"}
      title={@page_title}
      action={@live_action}
      board={@board}
      column={(@live_action == :edit_column && @column) || %Kanban.Columns.Column{}}
      patch={~p"/boards/#{@board}"}
    />
  </KanbanWeb.DelayedModal.delayed_modal>

  <KanbanWeb.DelayedModal.delayed_modal
    :if={@live_action in [:new_task, :edit_task]}
    id="task-modal"
    show
    on_cancel={JS.patch(~p"/boards/#{@board}")}
  >
    <.live_component
      module={KanbanWeb.TaskLive.FormComponent}
      id={(@live_action == :new_task && :new) || "edit-#{@task.id}"}
      title={@page_title}
      action={@live_action}
      board={@board}
      task={(@live_action == :edit_task && @task) || %Kanban.Tasks.Task{}}
      column_id={(@live_action == :new_task && Map.get(assigns, :column_id)) || nil}
      patch={~p"/boards/#{@board}"}
    />
  </KanbanWeb.DelayedModal.delayed_modal>

  <div :if={@viewing_task_id && @show_task_modal} id={"task-modal-wrapper-#{@viewing_task_id}"}>
    <KanbanWeb.DelayedModal.delayed_modal
      id="task-view-modal"
      show
      on_cancel={JS.push("close_task_view")}
    >
      <.live_component
        module={KanbanWeb.TaskLive.ViewComponent}
        id={"view-task-#{@viewing_task_id}"}
        task_id={@viewing_task_id}
        board_id={@board.id}
        can_modify={@can_modify}
        field_visibility={@field_visibility}
      />
    </KanbanWeb.DelayedModal.delayed_modal>
  </div>

  <%!-- API Tokens Modal --%>
  <.modal
      :if={@live_action == :api_tokens}
      id="api-tokens-modal"
      show
      on_cancel={JS.patch(~p"/boards/#{@board}")}
    >
      <h2 class="text-2xl font-bold mb-6">{gettext("API Tokens for %{board_name}", board_name: @board.name)}</h2>

      <div class="space-y-6">
        <%= if @new_token do %>
          <div class="alert alert-success">
            <div class="flex-1">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="stroke-current flex-shrink-0 h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <div class="flex-1">
                <h3 class="font-bold">{gettext("Token created successfully!")}</h3>
                <div class="text-sm">
                  {gettext("Copy this token now - you won't be able to see it again:")}
                </div>
                <div class="mt-2 flex gap-2">
                  <code
                    id="new-token-value"
                    class="bg-base-300 px-3 py-2 rounded font-mono text-sm flex-1 break-all"
                  >
                    <%= @new_token %>
                  </code>
                  <button
                    type="button"
                    class="btn btn-sm"
                    onclick="
                      const text = this.getAttribute('data-token-value');
                      const copiedText = this.getAttribute('data-copied-text');
                      const copyText = this.getAttribute('data-copy-text');
                      const textarea = document.createElement('textarea');
                      textarea.value = text;
                      textarea.style.position = 'fixed';
                      textarea.style.opacity = '0';
                      document.body.appendChild(textarea);
                      textarea.select();
                      try {
                        document.execCommand('copy');
                        this.innerHTML = copiedText;
                        setTimeout(() => { this.innerHTML = copyText; }, 2000);
                      } catch (err) {
                        console.error('Copy failed:', err);
                        alert('Failed to copy: ' + err.message);
                      } finally {
                        document.body.removeChild(textarea);
                      }
                    "
                    data-token-value={@new_token}
                    data-copy-text={gettext("Copy")}
                    data-copied-text={"✓ " <> gettext("Copied!")}
                  >{gettext("Copy")}</button>
                </div>
              </div>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-ghost"
              phx-click="dismiss_token"
              title={gettext("Dismiss")}
            >
              ×
            </button>
          </div>
        <% end %>

        <.form for={@token_form} phx-submit="create_token">
          <.input
            field={@token_form[:name]}
            type="text"
            label={gettext("Token Name")}
            placeholder={gettext("My AI Agent")}
            required
          />

          <.input
            field={@token_form[:agent_model]}
            type="text"
            label={gettext("Agent Model (Optional)")}
            placeholder="claude-3-opus"
          />

          <.input
            field={@token_form[:agent_purpose]}
            type="text"
            label={gettext("Purpose (Optional)")}
            placeholder="Task automation"
          />

          <div class="mt-4">
            <.button phx-disable-with={gettext("Creating...")}>
              {gettext("Generate Token")}
            </.button>
          </div>
        </.form>

        <div class="divider"></div>

        <div>
          <h3 class="text-lg font-semibold text-base-content mb-3">
            {gettext("Active Tokens")}
          </h3>
          <%= if Enum.empty?(@api_tokens) do %>
            <p class="text-base-content opacity-60 italic">
              {gettext("No API tokens yet. Generate one above to get started.")}
            </p>
          <% else %>
            <div class="overflow-x-auto">
              <table class="table table-zebra w-full table-sm">
                <thead>
                  <tr>
                    <th>{gettext("Name")}</th>
                    <th>{gettext("User")}</th>
                    <th>{gettext("Last Used")}</th>
                    <th>{gettext("Actions")}</th>
                  </tr>
                </thead>
                <tbody>
                  <%= for token <- @api_tokens do %>
                    <tr>
                      <td>
                        <%= token.name %>
                        <%= if token.agent_model do %>
                          <br />
                          <span class="text-xs opacity-60">
                            <%= token.agent_model %>
                          </span>
                        <% end %>
                      </td>
                      <td><%= token.user.email %></td>
                      <td>
                        <%= if token.last_used_at do %>
                          <%= Calendar.strftime(token.last_used_at, "%Y-%m-%d %H:%M") %>
                        <% else %>
                          <span class="opacity-60">{gettext("Never")}</span>
                        <% end %>
                      </td>
                      <td>
                        <%= if is_nil(token.revoked_at) do %>
                          <button
                            type="button"
                            class="btn btn-xs btn-error"
                            phx-click="revoke_token"
                            phx-value-id={token.id}
                            data-confirm={gettext("Are you sure you want to revoke this token?")}
                          >
                            {gettext("Revoke")}
                          </button>
                        <% else %>
                          <span class="badge badge-error">{gettext("Revoked")}</span>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        </div>
      </div>
    </.modal>
</Layouts.app>
